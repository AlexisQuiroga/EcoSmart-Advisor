{% extends "layout.html" %}

{% block title %}Simulador{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Simulador de Energía Renovable</h2>
            </div>
            <div class="card-body p-4">
                <p class="lead mb-4">En esta sección puede simular distintos escenarios de instalación de sistemas de energía renovable para evaluar rendimiento, ahorro y beneficio ambiental.</p>
                
                <form id="simuladorForm" method="POST" action="{{ url_for('simulador.simulador') }}">
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Configuración de Simulación</h3>
                        
                        <div class="mb-3">
                            <label for="tipo_instalacion" class="form-label">Tipo de Instalación <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipo_instalacion" name="tipo_instalacion" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="solar">Sistema Solar Fotovoltaico</option>
                                <option value="eolica">Sistema Eólico (aerogenerador)</option>
                                <option value="termotanque">Termotanque Solar</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="capacidad" class="form-label">Capacidad <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text" id="unidad_prefijo"><i class="fas fa-bolt"></i></span>
                                <input type="number" class="form-control" id="capacidad" name="capacidad" 
                                       placeholder="Capacidad del sistema" min="0.1" step="0.1" required>
                                <span class="input-group-text" id="unidad_capacidad">kW</span>
                            </div>
                            <div class="form-text" id="capacidad_descripcion">Potencia total del sistema fotovoltaico</div>
                            <div class="mt-2">
                                <div class="alert alert-info p-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <small>
                                        <strong>Solar Fotovoltaico:</strong> Potencia en kilovatios (kW). Un hogar típico puede requerir entre 2-5 kW.<br>
                                        <strong>Sistema Eólico:</strong> Potencia nominal del aerogenerador en kW. Sistemas residenciales suelen ser de 1-5 kW.<br>
                                        <strong>Termotanque Solar:</strong> Capacidad en litros. Sistemas familiares habitualmente entre 150-300 litros.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                            
                            <!-- Se eliminaron los campos de texto y el botón de validación -->
                            <!-- Los campos ahora son ocultos y se actualizan desde el mapa -->
                            <div class="alert alert-info">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Seleccione su ubicación directamente en el mapa haciendo clic en el punto deseado
                            </div>
                            
                            <!-- Campos ocultos para compatibilidad con JS -->
                            <input type="hidden" id="pais" name="pais" value="">
                            <input type="hidden" id="provincia" name="provincia" value="">
                            <input type="hidden" id="ciudad" name="ciudad" value="">
                            <input type="hidden" id="direccion" name="direccion" value="">
                            
                            <!-- Campos ocultos para almacenar la ubicación y coordenadas -->
                            <input type="hidden" id="ubicacion" name="ubicacion" required>
                            <input type="hidden" id="latitud" name="latitud">
                            <input type="hidden" id="longitud" name="longitud">
                            <input type="hidden" id="descripcion_ubicacion" name="descripcion_ubicacion">
                            
                            <div class="mt-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Seleccione su ubicación en el mapa</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-primary" id="centrarEnArgentina">
                                            <i class="fas fa-globe-americas me-1"></i>Argentina
                                        </button>
                                    </div>
                                </div>
                                <!-- Mensaje de error para problemas con el mapa -->
                                <div id="location-error-message" class="alert alert-danger mb-3" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="error-text">Error al cargar el mapa. Por favor, recargue la página.</span>
                                </div>
                                
                                <div class="position-relative">
                                    <!-- El mapa siempre visible con clase para móvil -->
                                    <div id="mapaUbicacion" class="rounded border mb-2 mapa-container" style="height: 400px; min-height: 250px; position: relative; z-index: 1;">
                                        <!-- El mapa se cargará aquí con JavaScript -->
                                        <noscript>
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                JavaScript es necesario para utilizar el mapa interactivo.
                                            </div>
                                        </noscript>
                                    </div>
                                    
                                    <!-- Botón auxiliar para dispositivos móviles donde el mapa pueda tener problemas -->
                                    <div id="mobile-map-helper" class="d-none d-sm-none">
                                        <button type="button" class="btn btn-sm btn-outline-primary mb-2" onclick="reiniciarMapa()">
                                            <i class="fas fa-sync-alt me-1"></i>Reiniciar mapa
                                        </button>
                                    </div>
                                    
                                    <script>
                                    // Detectar si es móvil para mostrar botón de reinicio
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                                        window.innerWidth <= 768;
                                        
                                        if (isMobile) {
                                            const helperDiv = document.getElementById('mobile-map-helper');
                                            if (helperDiv) {
                                                helperDiv.classList.remove('d-none', 'd-sm-none');
                                            }
                                        }
                                    });
                                    
                                    // Función para reiniciar el mapa en dispositivos móviles
                                    function reiniciarMapa() {
                                        const mapaDiv = document.getElementById('mapaUbicacion');
                                        if (mapaDiv) {
                                            // Limpiar el contenedor
                                            mapaDiv.innerHTML = '';
                                            
                                            // Si existe la función cargarLeaflet, llamarla
                                            if (typeof cargarLeaflet === 'function') {
                                                setTimeout(cargarLeaflet, 100);
                                            } else {
                                                // Recargar la página si no hay función de recarga
                                                window.location.reload();
                                            }
                                        }
                                    }
                                    </script>
                                    <div id="map-loading-indicator" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border text-success" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
                                            <span class="ms-2 small">Cargando mapa...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Instrucciones para el usuario -->
                                <div class="alert alert-info mt-2 mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Cómo usar:</strong> Haga clic directamente en el mapa para marcar su ubicación exacta.
                                </div>
                                <!-- Panel para mostrar las coordenadas seleccionadas -->
                                <div id="coordenadasSeleccionadas" class="d-none d-flex align-items-center bg-light rounded p-3 mb-2 border">
                                    <div class="me-3">
                                        <i class="fas fa-map-marker-alt text-danger fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Ubicación seleccionada</h6>
                                        <div>
                                            <span id="ubicacionDescripcion" class="d-block text-success fw-bold mb-1">Cargando descripción...</span>
                                        </div>
                                        <div class="small text-muted">
                                            Coordenadas: <span id="latitudSeleccionada">0.000000</span>,
                                            <span id="longitudSeleccionada">0.000000</span>
                                        </div>
                                    </div>
                                    <button type="button" id="usarCoordenadas" class="btn btn-success ms-auto">
                                        <i class="fas fa-check me-1"></i>Confirmar ubicación
                                    </button>
                                </div>
                                
                                <div class="form-text" id="coordenadasInfo">
                                    Coordenadas: <span id="latitudDisplay">--</span>, <span id="longitudDisplay">--</span>
                                </div>
                                <div id="location-error-message" class="alert alert-danger mt-2" style="display: none; font-size: 0.9rem;">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <span id="error-text">No se pudo encontrar la ubicación exacta.</span>
                                    <div class="mt-1 small">
                                        Por favor, haga clic directamente en el mapa para seleccionar su ubicación.
                                    </div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" 
                                           onclick="document.getElementById('location-error-message').style.display='none';"></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="consumo_mensual" class="form-label">Consumo Eléctrico Mensual <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-plug"></i></span>
                                <input type="number" class="form-control" id="consumo_mensual" name="consumo_mensual" 
                                       placeholder="Consumo mensual en kWh" min="1" required>
                                <span class="input-group-text">kWh/mes</span>
                            </div>
                            <div class="form-text">Consumo promedio mensual de electricidad</div>
                            <div class="mt-2">
                                <div class="alert alert-info p-2">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <small>
                                        Encuentre este dato en su factura de electricidad o calcúlelo multiplicando la potencia de sus electrodomésticos por las horas de uso. Una casa promedio consume entre 200-400 kWh/mes, dependiendo del tamaño y equipamiento.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="factores_opcionales">
                            <div class="card border-light mb-3">
                                <div class="card-header bg-light">Factores opcionales (valores por defecto recomendados)</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6" id="campo_eficiencia">
                                            <label for="eficiencia" class="form-label">Eficiencia del sistema</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="eficiencia" name="eficiencia" 
                                                       placeholder="Eficiencia" min="1" max="100" value="85" step="0.1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                            <div class="form-text">Porcentaje de energía efectivamente aprovechada después de pérdidas en inversores, cables y otros componentes</div>
                                        </div>
                                        <div class="col-md-6" id="campo_inclinacion">
                                            <label for="inclinacion" class="form-label">Inclinación paneles</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="inclinacion" name="inclinacion" 
                                                       placeholder="Inclinación" min="0" max="90" value="30">
                                                <span class="input-group-text">grados</span>
                                            </div>
                                            <div class="form-text">Ángulo de inclinación de los paneles con respecto a la horizontal. El óptimo suele estar cerca de la latitud local</div>
                                        </div>
                                        <div class="col-md-6" id="campo_orientacion">
                                            <label for="orientacion" class="form-label">Orientación</label>
                                            <select class="form-select" id="orientacion" name="orientacion">
                                                <option value="norte" selected>Norte</option>
                                                <option value="noreste">Noreste</option>
                                                <option value="este">Este</option>
                                                <option value="sureste">Sureste</option>
                                                <option value="sur">Sur</option>
                                                <option value="suroeste">Suroeste</option>
                                                <option value="oeste">Oeste</option>
                                                <option value="noroeste">Noroeste</option>
                                            </select>
                                            <div class="form-text">Dirección hacia donde apuntan los paneles. En hemisferio sur, el norte maximiza la captación solar</div>
                                        </div>
                                        <div class="col-md-6" id="campo_altura_torre">
                                            <label for="altura_torre" class="form-label">Altura de la torre</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="altura_torre" name="altura_torre" 
                                                       placeholder="Altura" min="1" value="15">
                                                <span class="input-group-text">metros</span>
                                            </div>
                                            <div class="form-text">Altura a la que se instala el aerogenerador. A mayor altura, mayor velocidad del viento y mejor rendimiento</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" id="ejecutarSimulacion" class="btn btn-primary btn-lg">
                            <i class="fas fa-play-circle me-2"></i>Ejecutar Simulación
                        </button>
                        <div id="form-error-mensaje" class="alert alert-danger mt-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="form-error-texto">Por favor, complete todos los campos requeridos.</span>
                        </div>
                    </div>
                    
                    <!-- Script de validación específico para este formulario -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const ejecutarBtn = document.getElementById('ejecutarSimulacion');
                            const formErrorMsg = document.getElementById('form-error-mensaje');
                            const formErrorTexto = document.getElementById('form-error-texto');
                            const formulario = document.getElementById('simuladorForm');
                            
                            // Cuando se hace clic en el botón
                            ejecutarBtn.addEventListener('click', function(e) {
                                // Verificar si se ha seleccionado una ubicación
                                const latitudInput = document.getElementById('latitud');
                                const longitudInput = document.getElementById('longitud');
                                
                                if (!latitudInput.value || !longitudInput.value) {
                                    e.preventDefault(); // Evitar envío del formulario
                                    
                                    // Mostrar mensaje de error específico
                                    formErrorMsg.style.display = 'block';
                                    formErrorTexto.textContent = 'Debe seleccionar y confirmar una ubicación en el mapa para continuar.';
                                    
                                    // Desplazarse al mensaje de error y luego al mapa
                                    formErrorMsg.scrollIntoView({ behavior: 'smooth' });
                                    
                                    setTimeout(function() {
                                        const mapaDiv = document.getElementById('mapaUbicacion');
                                        if (mapaDiv) {
                                            mapaDiv.scrollIntoView({ behavior: 'smooth' });
                                        }
                                    }, 1500);
                                    
                                    return false;
                                }
                                
                                // Si hay otros campos obligatorios, verificarlos aquí
                                
                                // Si todo está bien, permitir el envío del formulario
                                formErrorMsg.style.display = 'none';
                            });
                        });
                    </script>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cargar Leaflet para dispositivos móviles y escritorio -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Script mejorado para verificar y cargar Leaflet de manera robusta -->
<script>
// Función de carga de Leaflet con múltiples CDNs de respaldo
function cargarLeaflet() {
    // Lista de CDNs alternativos para Leaflet
    const cdnOptions = [
        {
            js: "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",
            css: "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        },
        {
            js: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js",
            css: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        },
        {
            js: "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js",
            css: "https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
        }
    ];
    
    // Verificar si Leaflet ya está disponible
    if (typeof L !== 'undefined') {
        console.log("Leaflet ya está disponible ✓");
        
        // Inicializar el mapa después de una pequeña pausa
        setTimeout(function() {
            if (typeof initMap === 'function' && document.getElementById('mapaUbicacion')) {
                console.log("Inicializando mapa con Leaflet existente");
                // Limpiar cualquier instancia previa
                document.getElementById('mapaUbicacion').innerHTML = '';
                initMap('mapaUbicacion');
            }
        }, 200);
        
        return true;
    }
    
    console.warn("Leaflet no disponible. Intentando carga alternativa...");
    
    // Cargar desde el primer CDN alternativo
    let cdnIndex = 0;
    
    function intentarSiguienteCDN() {
        if (cdnIndex >= cdnOptions.length) {
            console.error("Todos los intentos de cargar Leaflet fallaron.");
            mostrarErrorMapa("No se pudo cargar Leaflet después de múltiples intentos.");
            return false;
        }
        
        const cdn = cdnOptions[cdnIndex];
        console.log("Intento " + (cdnIndex + 1) + ": Cargando Leaflet desde " + cdn.js);
        
        // Primero cargar el CSS
        const cssLink = document.createElement('link');
        cssLink.rel = "stylesheet";
        cssLink.href = cdn.css;
        document.head.appendChild(cssLink);
        
        // Luego cargar el JavaScript
        const jsScript = document.createElement('script');
        jsScript.src = cdn.js;
        
        jsScript.onload = function() {
            console.log("✓ Leaflet cargado exitosamente desde " + cdn.js);
            
            // Inicializar mapa después de confirmar que Leaflet está disponible
            setTimeout(function() {
                if (typeof L !== 'undefined' && typeof initMap === 'function') {
                    console.log("Inicializando mapa después de carga alternativa");
                    initMap('mapaUbicacion');
                } else {
                    console.error("Leaflet se cargó pero no está disponible como L");
                }
            }, 300);
        };
        
        jsScript.onerror = function() {
            console.warn("✗ Error al cargar Leaflet desde " + cdn.js);
            cdnIndex++;
            intentarSiguienteCDN();
        };
        
        document.head.appendChild(jsScript);
    }
    
    intentarSiguienteCDN();
}

// Mostrar mensaje de error en el mapa
function mostrarErrorMapa(mensaje) {
    const errorMsgEl = document.getElementById('location-error-message');
    if (errorMsgEl) {
        errorMsgEl.style.display = 'block';
        const errorTextEl = errorMsgEl.querySelector('#error-text');
        if (errorTextEl) {
            errorTextEl.textContent = mensaje || "Error al cargar el mapa. Por favor, recargue la página.";
        }
    }
    
    // También mostrar mensaje directo en el contenedor del mapa
    const mapaContainer = document.getElementById('mapaUbicacion');
    if (mapaContainer) {
        mapaContainer.innerHTML = '<div class="alert alert-danger p-3 m-0"><i class="fas fa-exclamation-triangle me-2"></i>' + 
            (mensaje || "Error al cargar el mapa. Por favor, recargue la página.") + 
            '<br><button class="btn btn-sm btn-outline-danger mt-2" onclick="window.location.reload()">Recargar página</button></div>';
    }
}

// Iniciar verificación y carga cuando el DOM está listo
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM cargado, verificando Leaflet...");
    
    // Timeout para asegurar que todo esté disponible
    setTimeout(function() {
        cargarLeaflet();
    }, 100);
    
    // Comprobar nuevamente después de un tiempo más largo por si el primer intento falla
    setTimeout(function() {
        if (typeof L === 'undefined') {
            console.warn("Segunda verificación: Leaflet aún no disponible...");
            cargarLeaflet();
        }
    }, 1000);
});
</script>

<!-- Cargar nuestro script personalizado para el mapa -->
<script src="{{ url_for('static', filename='js/mapa-simple.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando formulario de simulador...");
    
    // Referencias a elementos del DOM
    const toggleMapBtn = document.getElementById('toggleMapBtn');
    const latitudInput = document.getElementById('latitud');
    const longitudInput = document.getElementById('longitud');
    const latitudDisplay = document.getElementById('latitudDisplay');
    const longitudDisplay = document.getElementById('longitudDisplay');
    const paisInput = document.getElementById('pais');
    const provinciaInput = document.getElementById('provincia');
    const ciudadInput = document.getElementById('ciudad');
    const direccionInput = document.getElementById('direccion');
    const ubicacionInput = document.getElementById('ubicacion');
    const validarUbicacionBtn = document.getElementById('validarUbicacionBtn');
    const validarUbicacionInfo = document.getElementById('validarUbicacionInfo');
    
    // Función para actualizar datos de ubicación
    function updateLocationData(lat, lng) {
        // Actualizar inputs ocultos
        latitudInput.value = lat;
        longitudInput.value = lng;
        
        // Actualizar textos visibles
        latitudDisplay.textContent = lat;
        longitudDisplay.textContent = lng;
        
        // Realizar geocodificación inversa para obtener la dirección
        reverseGeocode(lat, lng, function(data) {
            if (data && data.address) {
                // Extraer información de la dirección
                const direccion = data.address.road || data.address.pedestrian || '';
                const numero = data.address.house_number || '';
                const ciudad = data.address.city || data.address.town || data.address.village || '';
                const provincia = data.address.state || '';
                const pais = data.address.country || '';
                
                // Actualizar campos si están disponibles
                if (pais) paisInput.value = pais;
                if (provincia) provinciaInput.value = provincia;
                if (ciudad) ciudadInput.value = ciudad;
                if (direccion) {
                    let direccionCompleta = direccion;
                    if (numero) direccionCompleta += ' ' + numero;
                    direccionInput.value = direccionCompleta;
                }
                
                // Actualizar ubicación completa
                updateFullLocation();
            }
        });
    }
    
    // Función para manejar el botón de validación de ubicación
    if (validarUbicacionBtn) {
        validarUbicacionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const pais = paisInput.value.trim();
            const provincia = provinciaInput.value.trim();
            const ciudad = ciudadInput.value.trim();
            const direccion = direccionInput.value.trim();
            
            // Verificar si todos los campos necesarios están completos
            const camposFaltantes = [];
            if (!pais) camposFaltantes.push('país');
            if (!provincia) camposFaltantes.push('provincia');
            if (!ciudad) camposFaltantes.push('ciudad');
            if (!direccion) camposFaltantes.push('dirección');
            
            if (camposFaltantes.length > 0) {
                // Mostrar mensaje de error si faltan campos
                validarUbicacionInfo.textContent = 'Complete: ' + camposFaltantes.join(', ');
                validarUbicacionInfo.className = 'ms-2 text-danger small';
                return;
            }
            
            // Mostrar mensaje de procesamiento
            validarUbicacionInfo.textContent = 'Ubicando en el mapa...';
            validarUbicacionInfo.className = 'ms-2 text-primary small';
            
            // Mostrar el mapa si está oculto
            const mapaDiv = document.getElementById('mapaUbicacion');
            if (mapaDiv.style.display === 'none') {
                toggleMap('mapaUbicacion');
            }
            
            // Inicializar o referenciar el mapa
            let map = window.ecosmartMap;
            if (!map) {
                map = initMap('mapaUbicacion');
                if (map) {
                    setupMapClickEvent(map, updateLocationData);
                }
            }
            
            if (map) {
                // Realizar geocodificación con todos los datos
                const queryCompleta = `${direccion}, ${ciudad}, ${provincia}, ${pais}`;
                console.log("Validando dirección completa:", queryCompleta);
                
                // Usar geocodificación directa para obtener coordenadas exactas
                geocodeAddress(queryCompleta, function(lat, lng, result, zoom) {
                    if (lat && lng) {
                        console.log("Ubicación encontrada:", lat, lng, "zoom:", zoom);
                        
                        // Asegurar que el zoom es apropiado para una dirección específica
                        const zoomLevel = 18; // Nivel de zoom apropiado para una dirección
                        
                        // Forzar la creación del marcador
                        setTimeout(function() {
                            // Intentar crear el marcador de diferentes maneras
                            let marker = addOrUpdateMarker(map, lat, lng, zoomLevel);
                            
                            if (!marker && window.debugEcosmart) {
                                console.warn("Usando método de emergencia para marcador");
                                window.debugEcosmart.emergencyCreateMarker(lat, lng);
                            }
                            
                            // Actualizar todos los datos de ubicación
                            updateLocationData(lat.toFixed(6), lng.toFixed(6));
                            
                            // Notificar éxito
                            validarUbicacionInfo.textContent = 'Ubicación encontrada y marcada en el mapa';
                            validarUbicacionInfo.className = 'ms-2 text-success small';
                        }, 200);
                    } else {
                        console.error("No se pudo ubicar la dirección");
                        validarUbicacionInfo.textContent = 'No se pudo encontrar la ubicación exacta';
                        validarUbicacionInfo.className = 'ms-2 text-danger small';
                        
                        // Mostrar mensaje de error más detallado
                        const errorMsgEl = document.getElementById('location-error-message');
                        const errorTextEl = document.getElementById('error-text');
                        
                        if (errorMsgEl && errorTextEl) {
                            // Personalizar mensaje según la dirección
                            let sugerencia = '';
                            
                            // Verificar si es una dirección de Argentina
                            if (pais.toLowerCase().includes('argent')) {
                                // Crear sugerencias específicas para Argentina
                                if (ciudad.toLowerCase().includes('rio tercero') || ciudad.toLowerCase().includes('río tercero')) {
                                    sugerencia = `Intente con: "${direccion}, Río Tercero, Córdoba, Argentina"`;
                                } else {
                                    sugerencia = `Intente con el formato: "Calle Número, ${ciudad}, ${provincia}, Argentina"`;
                                }
                                
                                errorTextEl.textContent = `No se pudo encontrar: "${direccion}, ${ciudad}, ${provincia}".`;
                                errorMsgEl.innerHTML = `
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <span>${errorTextEl.textContent}</span>
                                    <div class="mt-1 small">
                                        ${sugerencia} o haga clic directamente en el mapa para seleccionar la ubicación manualmente.
                                    </div>
                                `;
                            } else {
                                errorTextEl.textContent = `No se pudo encontrar la ubicación exacta.`;
                                errorMsgEl.innerHTML = `
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <span>${errorTextEl.textContent}</span>
                                    <div class="mt-1 small">
                                        Intente con otro formato de dirección o haga clic directamente en el mapa.
                                    </div>
                                `;
                            }
                            
                            errorMsgEl.style.display = 'block';
                        }
                    }
                }, 18); // Pasar nivel de zoom alto por defecto
            }
        });
    }
    
    // Configurar evento para el botón de mostrar/ocultar mapa
    if (toggleMapBtn) {
        toggleMapBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log("Click en botón mostrar/ocultar mapa");
            
            // Usar la función de toggle del módulo
            const isVisible = toggleMap('mapaUbicacion');
            
            // Si el mapa está visible ahora, inicializarlo y configurar eventos
            if (isVisible) {
                const map = initMap('mapaUbicacion');
                
                if (map) {
                    // Configurar el evento de clic en el mapa para actualizar la ubicación
                    setupMapClickEvent(map, function(lat, lng, addressData) {
                        console.log("Datos de dirección recibidos del clic:", addressData);
                        
                        // Actualizar coordenadas
                        updateLocationData(lat, lng);
                        
                        // Si tenemos datos de dirección, actualizar los campos de ubicación
                        if (addressData && addressData.address) {
                            try {
                                // Extraer componentes de la dirección
                                const addr = addressData.address;
                                
                                // Actualizar país si está disponible
                                if (addr.country && paisInput) {
                                    paisInput.value = addr.country;
                                    // Disparar el evento change para activar cualquier lógica asociada
                                    const event = new Event('change');
                                    paisInput.dispatchEvent(event);
                                }
                                
                                // Actualizar provincia - usar state, state_district o county según disponibilidad
                                if (provinciaInput) {
                                    if (addr.state) {
                                        provinciaInput.value = addr.state;
                                    } else if (addr.state_district) {
                                        provinciaInput.value = addr.state_district;
                                    } else if (addr.county) {
                                        provinciaInput.value = addr.county;
                                    }
                                    // Disparar el evento change
                                    const event = new Event('change');
                                    provinciaInput.dispatchEvent(event);
                                }
                                
                                // Actualizar ciudad - usar city, town, o village según disponibilidad
                                if (ciudadInput) {
                                    if (addr.city) {
                                        ciudadInput.value = addr.city;
                                    } else if (addr.town) {
                                        ciudadInput.value = addr.town;
                                    } else if (addr.village) {
                                        ciudadInput.value = addr.village;
                                    }
                                    // Disparar el evento change
                                    const event = new Event('change');
                                    ciudadInput.dispatchEvent(event);
                                }
                                
                                // Actualizar dirección - combinar road, house_number y suburb para una dirección más completa
                                if (direccionInput) {
                                    let direccionCompleta = '';
                                    
                                    if (addr.road) {
                                        direccionCompleta += addr.road;
                                        if (addr.house_number) {
                                            direccionCompleta += ' ' + addr.house_number;
                                        }
                                    }
                                    
                                    if (addr.suburb && !direccionCompleta.includes(addr.suburb)) {
                                        direccionCompleta += (direccionCompleta ? ', ' : '') + addr.suburb;
                                    }
                                    
                                    if (direccionCompleta) {
                                        direccionInput.value = direccionCompleta;
                                        // Disparar el evento change
                                        const event = new Event('change');
                                        direccionInput.dispatchEvent(event);
                                    }
                                }
                                
                                // Actualizar la ubicación completa
                                setTimeout(function() {
                                    updateFullLocation();
                                }, 100);
                            } catch (error) {
                                console.error("Error al procesar datos de dirección:", error);
                            }
                        }
                    });
                }
            }
        });
    }
    
    // Función para actualizar el campo oculto de ubicación completa
    function updateFullLocation() {
        const pais = paisInput ? paisInput.value.trim() : '';
        const provincia = provinciaInput ? provinciaInput.value.trim() : '';
        const ciudad = ciudadInput ? ciudadInput.value.trim() : '';
        const direccion = direccionInput ? direccionInput.value.trim() : '';
        const latitud = latitudInput ? latitudInput.value.trim() : '';
        const longitud = longitudInput ? longitudInput.value.trim() : '';
        
        console.log("Actualizando ubicación completa con:", {pais, provincia, ciudad, direccion, latitud, longitud});
        
        let ubicacionCompleta = '';
        
        // Primero añadir dirección textual si existe
        if (direccion) {
            ubicacionCompleta += direccion;
            if (ciudad || provincia || pais) ubicacionCompleta += ', ';
        }
        
        if (ciudad) {
            ubicacionCompleta += ciudad;
            if (provincia || pais) ubicacionCompleta += ', ';
        }
        
        if (provincia) {
            ubicacionCompleta += provincia;
            if (pais) ubicacionCompleta += ', ';
        }
        
        if (pais) {
            ubicacionCompleta += pais;
        }
        
        // Si hay coordenadas y no hay texto, usar las coordenadas
        if ((!ubicacionCompleta || ubicacionCompleta.trim() === ',') && latitud && longitud) {
            ubicacionCompleta = `${latitud}, ${longitud}`;
        }
        
        // Asignar al campo oculto
        if (ubicacionCompleta && ubicacionInput) {
            console.log("Ubicación completa:", ubicacionCompleta);
            ubicacionInput.value = ubicacionCompleta;
        }
    }
    
    // Configurar eventos para los campos de ubicación
    // País: actualizar al cambiar
    if (paisInput) {
        paisInput.addEventListener('change', function() {
            updateFullLocation();
            if (provinciaInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        paisInput.addEventListener('input', updateFullLocation);
    }
    
    // Provincia: geocodificar inmediatamente al cambiar
    if (provinciaInput) {
        provinciaInput.addEventListener('change', function() {
            updateFullLocation();
            if (provinciaInput.value.trim() && paisInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        provinciaInput.addEventListener('input', updateFullLocation);
    }
    
    // Ciudad: geocodificar inmediatamente al cambiar
    if (ciudadInput) {
        ciudadInput.addEventListener('change', function() {
            updateFullLocation();
            if (ciudadInput.value.trim() && provinciaInput.value.trim() && paisInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        ciudadInput.addEventListener('input', updateFullLocation);
    }
    
    // Dirección: geocodificar después de una pequeña pausa al escribir
    if (direccionInput) {
        let typingTimer;
        const doneTypingInterval = 800; // Tiempo en ms (reducido para mayor reactividad)
        
        direccionInput.addEventListener('keyup', function() {
            clearTimeout(typingTimer);
            if (direccionInput.value.trim()) {
                typingTimer = setTimeout(function() {
                    updateFullLocation();
                    // Verificar si tenemos suficiente información para geocodificar
                    const todosLosCamposCompletos = paisInput.value.trim() && 
                                                  provinciaInput.value.trim() && 
                                                  ciudadInput.value.trim() && 
                                                  direccionInput.value.trim();
                    
                    // Siempre actualizar el mapa para mostrar la vista general
                    if (provinciaInput.value.trim() && paisInput.value.trim()) {
                        tryToGeocodeAddress();
                    }
                    
                    // Si tenemos una dirección completa, actualizar la UI para indicar que está lista
                    if (todosLosCamposCompletos) {
                        console.log("Dirección completa lista para geocodificación precisa");
                        // Actualizar indicador visual
                        const indicador = document.getElementById('direccion-estado');
                        const ayudaTexto = document.getElementById('direccion-ayuda');
                        if (indicador) {
                            indicador.className = 'input-group-text bg-success text-white';
                            indicador.innerHTML = '<i class="fas fa-check"></i>';
                        }
                        if (ayudaTexto) {
                            ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                            ayudaTexto.className = 'form-text text-success';
                        }
                    } else {
                        // Restablecer indicador visual
                        const indicador = document.getElementById('direccion-estado');
                        const ayudaTexto = document.getElementById('direccion-ayuda');
                        if (indicador) {
                            indicador.className = 'input-group-text bg-transparent';
                            indicador.innerHTML = '<i class="fas fa-map-marker-alt text-muted"></i>';
                        }
                        if (ayudaTexto) {
                            ayudaTexto.textContent = 'Ingrese la calle y número para ubicación exacta';
                            ayudaTexto.className = 'form-text';
                        }
                    }
                }, doneTypingInterval);
            }
        });
        
        direccionInput.addEventListener('keydown', function() {
            clearTimeout(typingTimer);
        });
        
        direccionInput.addEventListener('change', function() {
            updateFullLocation();
            
            // Verificar si tenemos todos los datos necesarios para una geocodificación completa
            const todosLosCamposCompletos = paisInput.value.trim() && 
                                          provinciaInput.value.trim() && 
                                          ciudadInput.value.trim() && 
                                          direccionInput.value.trim();
            
            if (todosLosCamposCompletos) {
                console.log("Dirección completa, realizando geocodificación precisa");
                // Actualizar indicador visual
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-success text-white';
                    indicador.innerHTML = '<i class="fas fa-check"></i>';
                }
                if (ayudaTexto) {
                    ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                    ayudaTexto.className = 'form-text text-success';
                }
                
                // Forzar un pequeño retraso para que termine de procesar el evento change
                setTimeout(function() {
                    tryToGeocodeAddress();
                }, 100);
            }
        });
        
        direccionInput.addEventListener('blur', function() {
            // Al perder el foco, intentar geocodificar si tenemos datos suficientes
            const todosLosCamposCompletos = paisInput.value.trim() && 
                                           provinciaInput.value.trim() && 
                                           ciudadInput.value.trim() && 
                                           direccionInput.value.trim();
            
            if (todosLosCamposCompletos) {
                console.log("Dirección completa (blur), realizando geocodificación precisa");
                
                // Actualizar indicador visual
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-success text-white';
                    indicador.innerHTML = '<i class="fas fa-check"></i>';
                }
                if (ayudaTexto) {
                    ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                    ayudaTexto.className = 'form-text text-success';
                }
                
                // Forzar un pequeño retraso para asegurar que los cambios de UI se apliquen
                setTimeout(function() {
                    tryToGeocodeAddress();
                }, 100);
            } else if (direccionInput.value.trim()) {
                // La dirección está parcialmente completa
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-warning text-white';
                    indicador.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                }
                if (ayudaTexto) {
                    const camposFaltantes = [];
                    if (!paisInput.value.trim()) camposFaltantes.push('país');
                    if (!provinciaInput.value.trim()) camposFaltantes.push('provincia');
                    if (!ciudadInput.value.trim()) camposFaltantes.push('ciudad');
                    
                    ayudaTexto.textContent = 'Falta completar: ' + camposFaltantes.join(', ');
                    ayudaTexto.className = 'form-text text-warning';
                }
            }
        });
        
        direccionInput.addEventListener('input', updateFullLocation);
    }
    
    // Función para intentar geocodificar la dirección progresivamente
    function tryToGeocodeAddress() {
        const pais = paisInput.value.trim();
        const provincia = provinciaInput.value.trim();
        const ciudad = ciudadInput.value.trim();
        const direccion = direccionInput.value.trim();
        
        // Log de datos ingresados
        console.log("Datos para geocodificación:", { pais, provincia, ciudad, direccion });
        
        // Verificar si todos los campos necesarios están completos para colocar el pin
        const todosLosCamposCompletos = pais && provincia && ciudad && direccion;
        
        console.log("¿Todos los campos completos?", todosLosCamposCompletos);
        
        // Solo intentar geocodificar si tenemos al menos la provincia
        if (provincia) {
            console.log("Iniciando geocodificación progresiva con:", { pais, provincia, ciudad, direccion });
            
            // Mostrar el mapa si está oculto
            const mapaDiv = document.getElementById('mapaUbicacion');
            if (mapaDiv.style.display === 'none') {
                toggleMap('mapaUbicacion');
                // Inicializar el mapa después de hacerlo visible
                setTimeout(function() {
                    const map = initMap('mapaUbicacion');
                    if (map) {
                        // Configurar el evento de clic después de inicializar
                        setupMapClickEvent(map, updateLocationData);
                        
                        // Usar geocodificación progresiva para ajustar la vista del mapa
                        geocodeProgressive(
                            { pais, provincia, ciudad, direccion }, 
                            function(lat, lng, result, zoom) {
                                if (lat && lng) {
                                    console.log("Geocodificación exitosa. Coordenadas:", lat, lng);
                                    
                                    // Solo colocar el pin si todos los campos están completos
                                    if (todosLosCamposCompletos) {
                                        console.log("Todos los campos completos, colocando pin...");
                                        
                                        // Forzar un tiempo de espera para asegurar que el mapa está listo
                                        setTimeout(function() {
                                            // Actualizar marcador y centrar mapa con el zoom apropiado
                                            const marker = addOrUpdateMarker(map, lat, lng, zoom);
                                            console.log("Resultado de addOrUpdateMarker:", marker ? "Pin creado" : "Fallo al crear pin");
                                            
                                            // Verificar si se creó el marcador
                                            if (!marker) {
                                                console.error("No se pudo crear el marcador. Intentando nuevamente...");
                                                // Intentar nuevamente con coordenadas verificadas
                                                marker = addOrUpdateMarker(map, parseFloat(lat), parseFloat(lng), zoom);
                                                
                                                // Si aún falla, usar método de emergencia
                                                if (!marker && window.debugEcosmart) {
                                                    console.warn("Intentando método de emergencia para crear marcador");
                                                    window.debugEcosmart.emergencyCreateMarker(lat, lng);
                                                }
                                            }
                                            
                                            // Verificar después de un momento que el marcador sigue visible
                                            setTimeout(function() {
                                                if (window.debugEcosmart) {
                                                    window.debugEcosmart.verifyMarker();
                                                    window.debugEcosmart.logState();
                                                }
                                            }, 500);
                                            
                                            // Actualizar datos de la ubicación
                                            updateLocationData(lat.toFixed(6), lng.toFixed(6));
                                        }, 200);
                                    } else {
                                        console.log("No todos los campos están completos, solo centrando mapa sin pin");
                                        // Solo centrar el mapa sin colocar el pin
                                        map.setView([lat, lng], zoom);
                                    }
                                } else {
                                    console.warn("Geocodificación falló. No se obtuvieron coordenadas.");
                                }
                            }
                        );
                    }
                }, 300);
            } else {
                // El mapa ya está visible, verificar si está inicializado
                if (ecosmartMap) {
                    // Usar geocodificación progresiva
                    geocodeProgressive(
                        { pais, provincia, ciudad, direccion }, 
                        function(lat, lng, result, zoom) {
                            if (lat && lng) {
                                // Solo colocar el pin si todos los campos están completos
                                if (todosLosCamposCompletos) {
                                    // Actualizar marcador y centrar mapa con el zoom apropiado
                                    addOrUpdateMarker(ecosmartMap, lat, lng, zoom);
                                    
                                    // Actualizar datos de la ubicación
                                    updateLocationData(lat.toFixed(6), lng.toFixed(6));
                                } else {
                                    // Solo centrar el mapa sin colocar el pin
                                    ecosmartMap.setView([lat, lng], zoom);
                                }
                            }
                        }
                    );
                }
            }
        }
    }
    
    // Adaptación de la interfaz según el tipo de instalación seleccionado
    const tipoInstalacionSelect = document.getElementById('tipo_instalacion');
    if (tipoInstalacionSelect) {
        tipoInstalacionSelect.addEventListener('change', function() {
            const tipoSeleccionado = this.value;
            const unidadCapacidad = document.getElementById('unidad_capacidad');
            const capacidadDescripcion = document.getElementById('capacidad_descripcion');
            const campoInclinacion = document.getElementById('campo_inclinacion');
            const campoOrientacion = document.getElementById('campo_orientacion');
            const campoAlturaTorre = document.getElementById('campo_altura_torre');
            
            // Ocultar todos los campos específicos por defecto
            campoInclinacion.style.display = 'none';
            campoOrientacion.style.display = 'none';
            campoAlturaTorre.style.display = 'none';
            
            // Mostrar campos según el tipo seleccionado
            if (tipoSeleccionado === 'solar') {
                unidadCapacidad.textContent = 'kW';
                capacidadDescripcion.textContent = 'Potencia total del sistema fotovoltaico';
                campoInclinacion.style.display = 'block';
                campoOrientacion.style.display = 'block';
            } else if (tipoSeleccionado === 'eolica') {
                unidadCapacidad.textContent = 'kW';
                capacidadDescripcion.textContent = 'Potencia nominal del aerogenerador';
                campoAlturaTorre.style.display = 'block';
            } else if (tipoSeleccionado === 'termotanque') {
                unidadCapacidad.textContent = 'litros';
                capacidadDescripcion.textContent = 'Capacidad del termotanque solar';
                campoInclinacion.style.display = 'block';
                campoOrientacion.style.display = 'block';
            }
        });
    }
    
    // Validación del formulario
    const formulario = document.getElementById('simuladorForm');
    if (formulario) {
        formulario.addEventListener('submit', function(event) {
            // Asegurarse de que la ubicación completa se actualice
            updateFullLocation();
            
            // Validar que tengamos al menos provincia y ciudad o coordenadas
            const provincia = provinciaInput.value;
            const ciudad = ciudadInput.value;
            const latitud = latitudInput.value;
            const longitud = longitudInput.value;
            
            if ((!provincia || !ciudad) && (!latitud || !longitud)) {
                event.preventDefault();
                alert('Por favor, indique su ubicación seleccionando provincia y ciudad o usando el mapa para seleccionar coordenadas.');
                return false;
            }
            
            // Validar capacidad
            const capacidad = document.getElementById('capacidad').value;
            const capacidadNum = parseFloat(capacidad);
            if (isNaN(capacidadNum) || capacidadNum <= 0) {
                event.preventDefault();
                alert('Por favor, ingrese un valor válido para la capacidad.');
                return false;
            }
            
            // Validar consumo mensual
            const consumo = document.getElementById('consumo_mensual').value;
            const consumoNum = parseFloat(consumo);
            if (isNaN(consumoNum) || consumoNum <= 0) {
                event.preventDefault();
                alert('Por favor, ingrese un valor válido para el consumo mensual.');
                return false;
            }
            
            return true;
        });
    }
});
</script>
{% endblock %}