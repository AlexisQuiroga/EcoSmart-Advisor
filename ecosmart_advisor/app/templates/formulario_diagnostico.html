{% extends "layout.html" %}

{% block title %}Diagnóstico{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h2 class="h4 mb-0"><i class="fas fa-clipboard-check me-2"></i>Diagnóstico de Energía Renovable</h2>
            </div>
            <div class="card-body p-4">
                <p class="lead mb-4">Complete el siguiente formulario para recibir una recomendación personalizada del sistema de energía renovable más adecuado para su caso.</p>
                
                <form id="diagnosticoForm" method="POST" action="{{ url_for('diagnostico.diagnostico') }}">
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Ubicación y Vivienda</h3>
                        
                        <div class="mb-3">
                            <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                            
                            <div class="row g-3 mb-2">
                                <div class="col-md-4">
                                    <label for="provincia" class="form-label small">Provincia/Estado</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                                        <input type="text" class="form-control" id="provincia" name="provincia" 
                                               placeholder="Provincia/Estado">
                                    </div>
                                    <div id="sugerenciasProvincia" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-4">
                                    <label for="ciudad" class="form-label small">Ciudad/Localidad</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                                        <input type="text" class="form-control" id="ciudad" name="ciudad" 
                                               placeholder="Ciudad/Localidad">
                                    </div>
                                    <div id="sugerenciasCiudad" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-4">
                                    <label for="direccion" class="form-label small">Dirección (opcional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                                        <input type="text" class="form-control" id="direccion" name="direccion" 
                                               placeholder="Calle, número...">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campos ocultos para almacenar la ubicación y coordenadas -->
                            <input type="hidden" id="ubicacion" name="ubicacion" required>
                            <input type="hidden" id="latitud" name="latitud">
                            <input type="hidden" id="longitud" name="longitud">
                            
                            <div class="mt-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">O seleccione su ubicación en el mapa</label>
                                    <button type="button" class="btn btn-sm btn-outline-success" id="toggleMapBtn">
                                        <i class="fas fa-map-marked-alt me-1"></i>Mostrar/Ocultar Mapa
                                    </button>
                                </div>
                                <div id="mapaUbicacion" class="rounded border mb-2" style="height: 300px; display: none;">
                                    <!-- El mapa se cargará aquí con JavaScript -->
                                </div>
                                <div class="form-text" id="coordenadasInfo">
                                    Coordenadas: <span id="latitudDisplay">--</span>, <span id="longitudDisplay">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tipo_vivienda" class="form-label">Tipo de Vivienda <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipo_vivienda" name="tipo_vivienda" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="casa_pequena">Casa pequeña (hasta 90m²)</option>
                                <option value="casa_mediana">Casa mediana (90-150m²)</option>
                                <option value="casa_grande">Casa grande (más de 150m²)</option>
                                <option value="apartamento">Apartamento</option>
                                <option value="oficina">Oficina</option>
                                <option value="comercio">Local comercial</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Consumo Energético</h3>
                        
                        <div class="mb-3">
                            <label for="consumo_mensual" class="form-label">Consumo Eléctrico Mensual (kWh)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-bolt"></i></span>
                                <input type="number" class="form-control" id="consumo_mensual" name="consumo_mensual" 
                                       placeholder="Consumo promedio mensual" min="0">
                                <span class="input-group-text">kWh</span>
                            </div>
                            <div class="form-text">Si no conoce su consumo, déjelo en blanco y lo estimaremos por usted</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Equipos Eléctricos (seleccione todos los que apliquen)</label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="aire_acondicionado" id="equipo_aire" name="equipos">
                                        <label class="form-check-label" for="equipo_aire">Aire acondicionado</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="calefaccion_electrica" id="equipo_calefaccion" name="equipos">
                                        <label class="form-check-label" for="equipo_calefaccion">Calefacción eléctrica</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="bomba_calor" id="equipo_bomba" name="equipos">
                                        <label class="form-check-label" for="equipo_bomba">Bomba de calor</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="refrigerador" id="equipo_refri" name="equipos">
                                        <label class="form-check-label" for="equipo_refri">Refrigerador/Congelador</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="lavadora" id="equipo_lavadora" name="equipos">
                                        <label class="form-check-label" for="equipo_lavadora">Lavadora</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="secadora" id="equipo_secadora" name="equipos">
                                        <label class="form-check-label" for="equipo_secadora">Secadora</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="lavavajillas" id="equipo_lavavajillas" name="equipos">
                                        <label class="form-check-label" for="equipo_lavavajillas">Lavavajillas</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="horno_electrico" id="equipo_horno" name="equipos">
                                        <label class="form-check-label" for="equipo_horno">Horno eléctrico</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="computadoras" id="equipo_computadoras" name="equipos">
                                        <label class="form-check-label" for="equipo_computadoras">Computadoras (más de 8h/día)</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="iluminacion_led" id="equipo_led" name="equipos">
                                        <label class="form-check-label" for="equipo_led">Iluminación LED</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="iluminacion_tradicional" id="equipo_trad" name="equipos">
                                        <label class="form-check-label" for="equipo_trad">Iluminación tradicional</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="piscina" id="equipo_piscina" name="equipos">
                                        <label class="form-check-label" for="equipo_piscina">Piscina (bomba/climatización)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Instalación Potencial</h3>
                        
                        <div class="mb-3">
                            <label for="superficie_disponible" class="form-label">Superficie Disponible <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-vector-square"></i></span>
                                <input type="number" class="form-control" id="superficie_disponible" name="superficie_disponible" 
                                       placeholder="Área disponible para instalación" min="1" required>
                                <span class="input-group-text">m²</span>
                            </div>
                            <div class="form-text">Superficie en techo, terreno u otra área donde podría instalar paneles o equipos</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="objetivo" class="form-label">Objetivo Principal <span class="text-danger">*</span></label>
                            <select class="form-select" id="objetivo" name="objetivo" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="ahorro">Maximizar ahorro económico</option>
                                <option value="ambiental">Minimizar impacto ambiental</option>
                                <option value="equilibrado">Equilibrio entre ahorro e impacto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-lightbulb me-2"></i>Generar Recomendación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cargar Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Cargar nuestro script personalizado para el mapa -->
<script src="{{ url_for('static', filename='js/leaflet-map.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando formulario de diagnóstico...");
    
    // Referencias a elementos del DOM
    const toggleMapBtn = document.getElementById('toggleMapBtn');
    const latitudInput = document.getElementById('latitud');
    const longitudInput = document.getElementById('longitud');
    const latitudDisplay = document.getElementById('latitudDisplay');
    const longitudDisplay = document.getElementById('longitudDisplay');
    const provinciaInput = document.getElementById('provincia');
    const ciudadInput = document.getElementById('ciudad');
    const direccionInput = document.getElementById('direccion');
    const ubicacionInput = document.getElementById('ubicacion');
    
    // Función para actualizar datos de ubicación
    function updateLocationData(lat, lng) {
        // Actualizar inputs ocultos
        latitudInput.value = lat;
        longitudInput.value = lng;
        
        // Actualizar textos visibles
        latitudDisplay.textContent = lat;
        longitudDisplay.textContent = lng;
        
        // Realizar geocodificación inversa para obtener la dirección
        reverseGeocode(lat, lng, function(data) {
            if (data && data.address) {
                // Extraer información de la dirección
                const direccion = data.address.road || data.address.pedestrian || '';
                const numero = data.address.house_number || '';
                const ciudad = data.address.city || data.address.town || data.address.village || '';
                const provincia = data.address.state || '';
                
                // Actualizar campos si están disponibles
                if (provincia) provinciaInput.value = provincia;
                if (ciudad) ciudadInput.value = ciudad;
                if (direccion) {
                    let direccionCompleta = direccion;
                    if (numero) direccionCompleta += ' ' + numero;
                    direccionInput.value = direccionCompleta;
                }
                
                // Actualizar ubicación completa
                updateFullLocation();
            }
        });
    }
    
    // Configurar evento para el botón de mostrar/ocultar mapa
    if (toggleMapBtn) {
        toggleMapBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log("Click en botón mostrar/ocultar mapa");
            
            // Usar la función de toggle del módulo
            const isVisible = toggleMap('mapaUbicacion');
            
            // Si el mapa está visible ahora, inicializarlo y configurar eventos
            if (isVisible) {
                const map = initMap('mapaUbicacion');
                
                if (map) {
                    setupMapClickEvent(map, updateLocationData);
                }
            }
        });
    }
    
    // Función para actualizar el campo oculto de ubicación completa
    function updateFullLocation() {
        const provincia = provinciaInput ? provinciaInput.value.trim() : '';
        const ciudad = ciudadInput ? ciudadInput.value.trim() : '';
        const direccion = direccionInput ? direccionInput.value.trim() : '';
        const latitud = latitudInput ? latitudInput.value.trim() : '';
        const longitud = longitudInput ? longitudInput.value.trim() : '';
        
        console.log("Actualizando ubicación completa con:", {provincia, ciudad, direccion, latitud, longitud});
        
        let ubicacionCompleta = '';
        
        // Primero añadir dirección textual si existe
        if (direccion) {
            ubicacionCompleta += direccion;
            if (ciudad || provincia) ubicacionCompleta += ', ';
        }
        
        if (ciudad) {
            ubicacionCompleta += ciudad;
            if (provincia) ubicacionCompleta += ', ';
        }
        
        if (provincia) {
            ubicacionCompleta += provincia;
        }
        
        // Si hay coordenadas y no hay texto, usar las coordenadas
        if ((!ubicacionCompleta || ubicacionCompleta.trim() === ',') && latitud && longitud) {
            ubicacionCompleta = `${latitud}, ${longitud}`;
        }
        
        // Asignar al campo oculto
        if (ubicacionCompleta && ubicacionInput) {
            console.log("Ubicación completa:", ubicacionCompleta);
            ubicacionInput.value = ubicacionCompleta;
        }
    }
    
    // Actualizar ubicación cuando cambian los campos individuales
    ['provincia', 'ciudad', 'direccion'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                updateFullLocation();
                tryToGeocodeAddress();
            });
            element.addEventListener('input', updateFullLocation);
        }
    });
    
    // Función para intentar geocodificar la dirección completa
    function tryToGeocodeAddress() {
        const provincia = provinciaInput.value.trim();
        const ciudad = ciudadInput.value.trim();
        const direccion = direccionInput.value.trim();
        
        // Solo intentar geocodificar si tenemos al menos ciudad y provincia
        if (provincia && ciudad) {
            // Construir dirección completa para geocodificar
            let direccionCompleta = '';
            
            if (direccion) {
                direccionCompleta += direccion + ', ';
            }
            
            direccionCompleta += ciudad + ', ' + provincia;
            
            console.log("Intentando geocodificar:", direccionCompleta);
            
            // Mostrar el mapa si está oculto
            const mapaDiv = document.getElementById('mapaUbicacion');
            if (mapaDiv.style.display === 'none') {
                toggleMap('mapaUbicacion');
                // Inicializar el mapa después de hacerlo visible
                setTimeout(function() {
                    const map = initMap('mapaUbicacion');
                    if (map) {
                        // Configurar el evento de clic después de inicializar
                        setupMapClickEvent(map, updateLocationData);
                        
                        // Geocodificar la dirección
                        geocodeAddress(direccionCompleta, function(lat, lng) {
                            if (lat && lng) {
                                // Actualizar marcador y centrar mapa
                                addOrUpdateMarker(map, lat, lng);
                                
                                // Actualizar datos de la ubicación
                                updateLocationData(lat.toFixed(6), lng.toFixed(6));
                            }
                        });
                    }
                }, 300);
            } else {
                // El mapa ya está visible, verificar si está inicializado
                if (ecosmartMap) {
                    // Geocodificar la dirección
                    geocodeAddress(direccionCompleta, function(lat, lng) {
                        if (lat && lng) {
                            // Actualizar marcador y centrar mapa
                            addOrUpdateMarker(ecosmartMap, lat, lng);
                            
                            // Actualizar datos de la ubicación
                            updateLocationData(lat.toFixed(6), lng.toFixed(6));
                        }
                    });
                }
            }
        }
    }
    
    // Validación del formulario
    const formulario = document.getElementById('diagnosticoForm');
    if (formulario) {
        formulario.addEventListener('submit', function(event) {
            // Asegurarse de que la ubicación completa se actualice
            updateFullLocation();
            
            // Validar que tengamos al menos provincia y ciudad o coordenadas
            const provincia = provinciaInput.value;
            const ciudad = ciudadInput.value;
            const latitud = latitudInput.value;
            const longitud = longitudInput.value;
            
            if ((!provincia || !ciudad) && (!latitud || !longitud)) {
                event.preventDefault();
                alert('Por favor, indique su ubicación seleccionando provincia y ciudad o usando el mapa para seleccionar coordenadas.');
                return false;
            }
            
            // Validar otros campos requeridos
            const tipoVivienda = document.getElementById('tipo_vivienda').value;
            const superficie = document.getElementById('superficie_disponible').value;
            const objetivo = document.getElementById('objetivo').value;
            
            if (!tipoVivienda || !superficie || !objetivo) {
                event.preventDefault();
                alert('Por favor, complete todos los campos obligatorios.');
                return false;
            }
            
            // Validar superficie (valor numérico positivo)
            const superficieNum = parseFloat(superficie);
            if (isNaN(superficieNum) || superficieNum <= 0) {
                event.preventDefault();
                alert('Por favor, ingrese un valor válido para la superficie disponible.');
                return false;
            }
            
            return true;
        });
    }
});
</script>
{% endblock %}