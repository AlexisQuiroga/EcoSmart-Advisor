{% extends "layout.html" %}

{% block title %}Simulador{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Simulador de Energía Renovable</h2>
            </div>
            <div class="card-body p-4">
                <p class="lead mb-4">En esta sección puede simular distintos escenarios de instalación de sistemas de energía renovable para evaluar rendimiento, ahorro y beneficio ambiental.</p>
                
                <form id="simuladorForm" method="POST" action="{{ url_for('simulador.simulador') }}">
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Configuración de Simulación</h3>
                        
                        <div class="mb-3">
                            <label for="tipo_instalacion" class="form-label">Tipo de Instalación <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipo_instalacion" name="tipo_instalacion" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="solar">Sistema Solar Fotovoltaico</option>
                                <option value="eolica">Sistema Eólico (aerogenerador)</option>
                                <option value="termotanque">Termotanque Solar</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="capacidad" class="form-label">Capacidad <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text" id="unidad_prefijo"><i class="fas fa-bolt"></i></span>
                                <input type="number" class="form-control" id="capacidad" name="capacidad" 
                                       placeholder="Capacidad del sistema" min="0.1" step="0.1" required>
                                <span class="input-group-text" id="unidad_capacidad">kW</span>
                            </div>
                            <div class="form-text" id="capacidad_descripcion">Potencia total del sistema fotovoltaico</div>
                            <div class="mt-2">
                                <div class="alert alert-info p-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="descripcion_tipo">Seleccione un tipo de instalación para ver más información.</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                            <p class="text-muted mb-3">Para un cálculo preciso, necesitamos conocer su ubicación. Por favor, marque directamente su posición en el mapa.</p>
                            
                            <!-- Campos ocultos para almacenar la ubicación y coordenadas -->
                            <input type="hidden" id="ubicacion" name="ubicacion" required>
                            <input type="hidden" id="latitud" name="latitud">
                            <input type="hidden" id="longitud" name="longitud">
                            <input type="hidden" id="descripcion_ubicacion" name="descripcion_ubicacion">
                            
                            <div class="position-relative mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">Seleccione su ubicación en el mapa</h5>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-primary" id="centrarEnArgentina">
                                            <i class="fas fa-globe-americas me-1"></i>Argentina
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- El mapa siempre visible -->
                                <div id="mapaUbicacion" class="rounded border mb-2" style="height: 400px;">
                                    <!-- El mapa se cargará aquí con JavaScript -->
                                </div>
                                
                                <div id="map-loading-indicator" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border text-success" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
                                        <span class="ms-2 small">Cargando mapa...</span>
                                    </div>
                                </div>
                                
                                <!-- Instrucciones para el usuario -->
                                <div class="alert alert-info mt-2 mb-2">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Cómo usar:</strong> Haga clic directamente en el mapa para marcar su ubicación exacta.
                                </div>
                                
                                <!-- Panel para mostrar las coordenadas seleccionadas -->
                                <div id="coordenadasSeleccionadas" class="d-none d-flex align-items-center bg-light rounded p-3 mb-2 border">
                                    <div class="me-3">
                                        <i class="fas fa-map-marker-alt text-danger fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">Ubicación seleccionada</h6>
                                        <div>
                                            <span id="ubicacionDescripcion" class="d-block text-success fw-bold mb-1">Coordenadas seleccionadas</span>
                                        </div>
                                        <div class="small text-muted">
                                            Coordenadas: <span id="latitudSeleccionada">0.000000</span>,
                                            <span id="longitudSeleccionada">0.000000</span>
                                        </div>
                                    </div>
                                    <button type="button" id="usarCoordenadas" class="btn btn-success ms-auto">
                                        <i class="fas fa-check me-1"></i>Confirmar ubicación
                                    </button>
                                </div>
                                
                                <div id="location-error-message" class="alert alert-danger mt-2" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="error-text">Debe seleccionar una ubicación en el mapa para continuar.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Datos de Uso</h3>
                        
                        <div class="mb-3">
                            <label for="consumo_mensual" class="form-label">Consumo Mensual <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-plug"></i></span>
                                <input type="number" class="form-control" id="consumo_mensual" name="consumo_mensual" 
                                       placeholder="Consumo mensual promedio" min="1" required>
                                <span class="input-group-text">kWh/mes</span>
                            </div>
                            <div class="form-text">Consumo eléctrico mensual promedio en kilovatios-hora</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tarifa" class="form-label">Tarifa Eléctrica <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                <input type="number" class="form-control" id="tarifa" name="tarifa" 
                                       placeholder="Precio por kWh" step="0.01" min="0.01" required>
                                <span class="input-group-text">$/kWh</span>
                            </div>
                            <div class="form-text">Precio que paga por cada kilovatio-hora de electricidad</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="presupuesto" class="form-label">Presupuesto Disponible</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-wallet"></i></span>
                                <input type="number" class="form-control" id="presupuesto" name="presupuesto" 
                                       placeholder="Presupuesto disponible" min="0" step="1000">
                                <span class="input-group-text">$</span>
                            </div>
                            <div class="form-text">Presupuesto estimado para la instalación (opcional)</div>
                        </div>
                    </div>
                    
                    <div class="mb-4 text-center">
                        <div class="d-grid gap-2 col-md-6 mx-auto">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calculator me-2"></i>Ejecutar Simulación
                            </button>
                        </div>
                        <p class="form-text mt-2">
                            La simulación calculará rendimiento, ahorro económico y beneficio ambiental
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cambiar unidades y descripción según el tipo de instalación
    const tipoSelect = document.getElementById('tipo_instalacion');
    const unidadCapacidad = document.getElementById('unidad_capacidad');
    const capacidadDescripcion = document.getElementById('capacidad_descripcion');
    const descripcionTipo = document.getElementById('descripcion_tipo');
    
    tipoSelect.addEventListener('change', function() {
        const tipo = this.value;
        
        // Establecer unidades y descripción según el tipo
        if (tipo === 'solar') {
            unidadCapacidad.textContent = 'kWp';
            capacidadDescripcion.textContent = 'Potencia pico de paneles solares fotovoltaicos';
            descripcionTipo.innerHTML = 'Los sistemas solares fotovoltaicos <strong>convierten la luz solar en electricidad</strong> mediante paneles. La capacidad se mide en kWp (kilovatios pico) que representa la potencia máxima que puede generar el sistema en condiciones óptimas.';
        } else if (tipo === 'eolica') {
            unidadCapacidad.textContent = 'kW';
            capacidadDescripcion.textContent = 'Potencia nominal del aerogenerador';
            descripcionTipo.innerHTML = 'Los sistemas eólicos <strong>aprovechan la fuerza del viento</strong> para generar electricidad. La capacidad representa la potencia nominal del aerogenerador a velocidad de viento óptima.';
        } else if (tipo === 'termotanque') {
            unidadCapacidad.textContent = 'L';
            capacidadDescripcion.textContent = 'Capacidad del termotanque en litros';
            descripcionTipo.innerHTML = 'Los termotanques solares <strong>calientan agua mediante energía solar térmica</strong>. La capacidad indica el volumen de agua que puede almacenar y calentar con energía solar.';
        }
    });
    
    // Verificar selección de ubicación antes de enviar
    const simuladorForm = document.getElementById('simuladorForm');
    
    simuladorForm.addEventListener('submit', function(event) {
        const latitudInput = document.getElementById('latitud');
        const longitudInput = document.getElementById('longitud');
        
        if (!latitudInput.value || !longitudInput.value) {
            event.preventDefault();
            
            // Mostrar mensaje de error
            const errorMsg = document.getElementById('location-error-message');
            if (errorMsg) {
                errorMsg.style.display = 'block';
                const errorText = errorMsg.querySelector('#error-text');
                if (errorText) {
                    errorText.textContent = 'Debe seleccionar una ubicación en el mapa para continuar.';
                }
            }
            
            // Desplazar a la sección del mapa
            const mapaUbicacion = document.getElementById('mapaUbicacion');
            if (mapaUbicacion) {
                mapaUbicacion.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Inicializar el mapa
    if (typeof initMap === 'function') {
        const map = initMap('mapaUbicacion');
        
        // Configurar evento de clic en el mapa si se inicializó correctamente
        if (map && typeof setupMapClickEvent === 'function') {
            setupMapClickEvent(map, function(lat, lng, addressData) {
                // Actualizar campos del formulario
                document.getElementById('latitud').value = lat;
                document.getElementById('longitud').value = lng;
                
                // Actualizar campos visuales
                document.getElementById('latitudSeleccionada').textContent = lat;
                document.getElementById('longitudSeleccionada').textContent = lng;
                
                // Actualizar ubicación si hay datos disponibles
                if (addressData && addressData.display_name) {
                    document.getElementById('ubicacion').value = addressData.display_name;
                    document.getElementById('ubicacionDescripcion').textContent = addressData.display_name;
                    document.getElementById('descripcion_ubicacion').value = addressData.display_name;
                } else {
                    document.getElementById('ubicacion').value = lat + ',' + lng;
                    document.getElementById('ubicacionDescripcion').textContent = 'Coordenadas: ' + lat + ', ' + lng;
                    document.getElementById('descripcion_ubicacion').value = '';
                }
                
                // Mostrar panel de coordenadas
                document.getElementById('coordenadasSeleccionadas').classList.remove('d-none');
                
                // Ocultar mensaje de error si estaba visible
                const errorMsg = document.getElementById('location-error-message');
                if (errorMsg) {
                    errorMsg.style.display = 'none';
                }
            });
            
            // Configurar botón para centrar en Argentina
            const centrarBtn = document.getElementById('centrarEnArgentina');
            if (centrarBtn) {
                centrarBtn.addEventListener('click', function() {
                    map.setView([-38.416097, -63.616672], 4);
                });
            }
            
            // Configurar botón para usar coordenadas
            const usarCoordenadasBtn = document.getElementById('usarCoordenadas');
            if (usarCoordenadasBtn) {
                usarCoordenadasBtn.addEventListener('click', function() {
                    // Verificar si se han seleccionado coordenadas
                    const latInput = document.getElementById('latitud');
                    const lngInput = document.getElementById('longitud');
                    
                    if (latInput.value && lngInput.value) {
                        // Ocultar mensaje de error si estaba visible
                        const errorMsg = document.getElementById('location-error-message');
                        if (errorMsg) {
                            errorMsg.style.display = 'none';
                        }
                        
                        // Desplazarse al siguiente campo
                        document.getElementById('consumo_mensual').focus();
                    } else {
                        alert('Por favor, seleccione una ubicación en el mapa primero.');
                    }
                });
            }
        }
    }
});
</script>
{% endblock %}