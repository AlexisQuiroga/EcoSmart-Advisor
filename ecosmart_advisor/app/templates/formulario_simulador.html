{% extends "layout.html" %}

{% block title %}Simulador{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Simulador de Energía Renovable</h2>
            </div>
            <div class="card-body p-4">
                <p class="lead mb-4">En esta sección puede simular distintos escenarios de instalación de sistemas de energía renovable para evaluar rendimiento, ahorro y beneficio ambiental.</p>
                
                <form id="simuladorForm" method="POST" action="{{ url_for('simulador.simulador') }}">
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Configuración de Simulación</h3>
                        
                        <div class="mb-3">
                            <label for="tipo_instalacion" class="form-label">Tipo de Instalación <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipo_instalacion" name="tipo_instalacion" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="solar">Sistema Solar Fotovoltaico</option>
                                <option value="eolica">Sistema Eólico (aerogenerador)</option>
                                <option value="termotanque">Termotanque Solar</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="capacidad" class="form-label">Capacidad <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text" id="unidad_prefijo"><i class="fas fa-bolt"></i></span>
                                <input type="number" class="form-control" id="capacidad" name="capacidad" 
                                       placeholder="Capacidad del sistema" min="0.1" step="0.1" required>
                                <span class="input-group-text" id="unidad_capacidad">kW</span>
                            </div>
                            <div class="form-text" id="capacidad_descripcion">Potencia total del sistema fotovoltaico</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                            
                            <div class="row g-3 mb-2">
                                <div class="col-md-3">
                                    <label for="pais" class="form-label small">País <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-globe-americas"></i></span>
                                        <input type="text" class="form-control" id="pais" name="pais" 
                                               placeholder="País" value="Argentina">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="provincia" class="form-label small">Provincia/Estado <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                                        <input type="text" class="form-control" id="provincia" name="provincia" 
                                               placeholder="Provincia/Estado">
                                    </div>
                                    <div id="sugerenciasProvincia" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-3">
                                    <label for="ciudad" class="form-label small">Ciudad/Localidad <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                                        <input type="text" class="form-control" id="ciudad" name="ciudad" 
                                               placeholder="Ciudad/Localidad">
                                    </div>
                                    <div id="sugerenciasCiudad" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-3">
                                    <label for="direccion" class="form-label small">Dirección <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                                        <input type="text" class="form-control" id="direccion" name="direccion" 
                                               placeholder="Calle, número...">
                                        <span class="input-group-text bg-transparent" id="direccion-estado">
                                            <i class="fas fa-map-marker-alt text-muted"></i>
                                        </span>
                                    </div>
                                    <div class="form-text" id="direccion-ayuda">Ingrese la calle y número para ubicación exacta</div>
                                </div>
                            </div>
                            
                            <!-- Botón para validar y ubicar en el mapa -->
                            <div class="text-end mb-2">
                                <button type="button" class="btn btn-sm btn-primary" id="validarUbicacionBtn">
                                    <i class="fas fa-map-pin me-1"></i>Ubicar en el Mapa
                                </button>
                                <span class="ms-2 text-muted small" id="validarUbicacionInfo">Complete todos los campos para ubicar</span>
                            </div>
                            
                            <!-- Campos ocultos para almacenar la ubicación y coordenadas -->
                            <input type="hidden" id="ubicacion" name="ubicacion" required>
                            <input type="hidden" id="latitud" name="latitud">
                            <input type="hidden" id="longitud" name="longitud">
                            
                            <div class="mt-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">O seleccione su ubicación en el mapa</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="toggleMapBtn">
                                        <i class="fas fa-map-marked-alt me-1"></i>Mostrar/Ocultar Mapa
                                    </button>
                                </div>
                                <div id="mapaUbicacion" class="rounded border mb-2" style="height: 300px; display: none;">
                                    <!-- El mapa se cargará aquí con JavaScript -->
                                </div>
                                <div class="form-text" id="coordenadasInfo">
                                    Coordenadas: <span id="latitudDisplay">--</span>, <span id="longitudDisplay">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="consumo_mensual" class="form-label">Consumo Eléctrico Mensual <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-plug"></i></span>
                                <input type="number" class="form-control" id="consumo_mensual" name="consumo_mensual" 
                                       placeholder="Consumo mensual en kWh" min="1" required>
                                <span class="input-group-text">kWh/mes</span>
                            </div>
                            <div class="form-text">Consumo promedio mensual de electricidad</div>
                        </div>
                        
                        <div class="mb-3" id="factores_opcionales">
                            <div class="card border-light mb-3">
                                <div class="card-header bg-light">Factores opcionales (valores por defecto recomendados)</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6" id="campo_eficiencia">
                                            <label for="eficiencia" class="form-label">Eficiencia del sistema</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="eficiencia" name="eficiencia" 
                                                       placeholder="Eficiencia" min="1" max="100" value="85" step="0.1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="campo_inclinacion">
                                            <label for="inclinacion" class="form-label">Inclinación paneles</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="inclinacion" name="inclinacion" 
                                                       placeholder="Inclinación" min="0" max="90" value="30">
                                                <span class="input-group-text">grados</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="campo_orientacion">
                                            <label for="orientacion" class="form-label">Orientación</label>
                                            <select class="form-select" id="orientacion" name="orientacion">
                                                <option value="norte" selected>Norte</option>
                                                <option value="noreste">Noreste</option>
                                                <option value="este">Este</option>
                                                <option value="sureste">Sureste</option>
                                                <option value="sur">Sur</option>
                                                <option value="suroeste">Suroeste</option>
                                                <option value="oeste">Oeste</option>
                                                <option value="noroeste">Noroeste</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6" id="campo_altura_torre">
                                            <label for="altura_torre" class="form-label">Altura de la torre</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="altura_torre" name="altura_torre" 
                                                       placeholder="Altura" min="1" value="15">
                                                <span class="input-group-text">metros</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play-circle me-2"></i>Ejecutar Simulación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cargar Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Cargar nuestro script personalizado para el mapa -->
<script src="{{ url_for('static', filename='js/leaflet-map.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando formulario de simulador...");
    
    // Referencias a elementos del DOM
    const toggleMapBtn = document.getElementById('toggleMapBtn');
    const latitudInput = document.getElementById('latitud');
    const longitudInput = document.getElementById('longitud');
    const latitudDisplay = document.getElementById('latitudDisplay');
    const longitudDisplay = document.getElementById('longitudDisplay');
    const paisInput = document.getElementById('pais');
    const provinciaInput = document.getElementById('provincia');
    const ciudadInput = document.getElementById('ciudad');
    const direccionInput = document.getElementById('direccion');
    const ubicacionInput = document.getElementById('ubicacion');
    
    // Función para actualizar datos de ubicación
    function updateLocationData(lat, lng) {
        // Actualizar inputs ocultos
        latitudInput.value = lat;
        longitudInput.value = lng;
        
        // Actualizar textos visibles
        latitudDisplay.textContent = lat;
        longitudDisplay.textContent = lng;
        
        // Realizar geocodificación inversa para obtener la dirección
        reverseGeocode(lat, lng, function(data) {
            if (data && data.address) {
                // Extraer información de la dirección
                const direccion = data.address.road || data.address.pedestrian || '';
                const numero = data.address.house_number || '';
                const ciudad = data.address.city || data.address.town || data.address.village || '';
                const provincia = data.address.state || '';
                const pais = data.address.country || '';
                
                // Actualizar campos si están disponibles
                if (pais) paisInput.value = pais;
                if (provincia) provinciaInput.value = provincia;
                if (ciudad) ciudadInput.value = ciudad;
                if (direccion) {
                    let direccionCompleta = direccion;
                    if (numero) direccionCompleta += ' ' + numero;
                    direccionInput.value = direccionCompleta;
                }
                
                // Actualizar ubicación completa
                updateFullLocation();
            }
        });
    }
    
    // Configurar evento para el botón de mostrar/ocultar mapa
    if (toggleMapBtn) {
        toggleMapBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log("Click en botón mostrar/ocultar mapa");
            
            // Usar la función de toggle del módulo
            const isVisible = toggleMap('mapaUbicacion');
            
            // Si el mapa está visible ahora, inicializarlo y configurar eventos
            if (isVisible) {
                const map = initMap('mapaUbicacion');
                
                if (map) {
                    // Configurar el evento de clic en el mapa para actualizar la ubicación
                    setupMapClickEvent(map, function(lat, lng, addressData) {
                        console.log("Datos de dirección recibidos del clic:", addressData);
                        
                        // Actualizar coordenadas
                        updateLocationData(lat, lng);
                        
                        // Si tenemos datos de dirección, actualizar los campos de ubicación
                        if (addressData && addressData.address) {
                            try {
                                // Extraer componentes de la dirección
                                const addr = addressData.address;
                                
                                // Actualizar país si está disponible
                                if (addr.country && paisInput) {
                                    paisInput.value = addr.country;
                                    // Disparar el evento change para activar cualquier lógica asociada
                                    const event = new Event('change');
                                    paisInput.dispatchEvent(event);
                                }
                                
                                // Actualizar provincia - usar state, state_district o county según disponibilidad
                                if (provinciaInput) {
                                    if (addr.state) {
                                        provinciaInput.value = addr.state;
                                    } else if (addr.state_district) {
                                        provinciaInput.value = addr.state_district;
                                    } else if (addr.county) {
                                        provinciaInput.value = addr.county;
                                    }
                                    // Disparar el evento change
                                    const event = new Event('change');
                                    provinciaInput.dispatchEvent(event);
                                }
                                
                                // Actualizar ciudad - usar city, town, o village según disponibilidad
                                if (ciudadInput) {
                                    if (addr.city) {
                                        ciudadInput.value = addr.city;
                                    } else if (addr.town) {
                                        ciudadInput.value = addr.town;
                                    } else if (addr.village) {
                                        ciudadInput.value = addr.village;
                                    }
                                    // Disparar el evento change
                                    const event = new Event('change');
                                    ciudadInput.dispatchEvent(event);
                                }
                                
                                // Actualizar dirección - combinar road, house_number y suburb para una dirección más completa
                                if (direccionInput) {
                                    let direccionCompleta = '';
                                    
                                    if (addr.road) {
                                        direccionCompleta += addr.road;
                                        if (addr.house_number) {
                                            direccionCompleta += ' ' + addr.house_number;
                                        }
                                    }
                                    
                                    if (addr.suburb && !direccionCompleta.includes(addr.suburb)) {
                                        direccionCompleta += (direccionCompleta ? ', ' : '') + addr.suburb;
                                    }
                                    
                                    if (direccionCompleta) {
                                        direccionInput.value = direccionCompleta;
                                        // Disparar el evento change
                                        const event = new Event('change');
                                        direccionInput.dispatchEvent(event);
                                    }
                                }
                                
                                // Actualizar la ubicación completa
                                setTimeout(function() {
                                    updateFullLocation();
                                }, 100);
                            } catch (error) {
                                console.error("Error al procesar datos de dirección:", error);
                            }
                        }
                    });
                }
            }
        });
    }
    
    // Función para actualizar el campo oculto de ubicación completa
    function updateFullLocation() {
        const pais = paisInput ? paisInput.value.trim() : '';
        const provincia = provinciaInput ? provinciaInput.value.trim() : '';
        const ciudad = ciudadInput ? ciudadInput.value.trim() : '';
        const direccion = direccionInput ? direccionInput.value.trim() : '';
        const latitud = latitudInput ? latitudInput.value.trim() : '';
        const longitud = longitudInput ? longitudInput.value.trim() : '';
        
        console.log("Actualizando ubicación completa con:", {pais, provincia, ciudad, direccion, latitud, longitud});
        
        let ubicacionCompleta = '';
        
        // Primero añadir dirección textual si existe
        if (direccion) {
            ubicacionCompleta += direccion;
            if (ciudad || provincia || pais) ubicacionCompleta += ', ';
        }
        
        if (ciudad) {
            ubicacionCompleta += ciudad;
            if (provincia || pais) ubicacionCompleta += ', ';
        }
        
        if (provincia) {
            ubicacionCompleta += provincia;
            if (pais) ubicacionCompleta += ', ';
        }
        
        if (pais) {
            ubicacionCompleta += pais;
        }
        
        // Si hay coordenadas y no hay texto, usar las coordenadas
        if ((!ubicacionCompleta || ubicacionCompleta.trim() === ',') && latitud && longitud) {
            ubicacionCompleta = `${latitud}, ${longitud}`;
        }
        
        // Asignar al campo oculto
        if (ubicacionCompleta && ubicacionInput) {
            console.log("Ubicación completa:", ubicacionCompleta);
            ubicacionInput.value = ubicacionCompleta;
        }
    }
    
    // Configurar eventos para los campos de ubicación
    // País: actualizar al cambiar
    if (paisInput) {
        paisInput.addEventListener('change', function() {
            updateFullLocation();
            if (provinciaInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        paisInput.addEventListener('input', updateFullLocation);
    }
    
    // Provincia: geocodificar inmediatamente al cambiar
    if (provinciaInput) {
        provinciaInput.addEventListener('change', function() {
            updateFullLocation();
            if (provinciaInput.value.trim() && paisInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        provinciaInput.addEventListener('input', updateFullLocation);
    }
    
    // Ciudad: geocodificar inmediatamente al cambiar
    if (ciudadInput) {
        ciudadInput.addEventListener('change', function() {
            updateFullLocation();
            if (ciudadInput.value.trim() && provinciaInput.value.trim() && paisInput.value.trim()) {
                tryToGeocodeAddress();
            }
        });
        ciudadInput.addEventListener('input', updateFullLocation);
    }
    
    // Dirección: geocodificar después de una pequeña pausa al escribir
    if (direccionInput) {
        let typingTimer;
        const doneTypingInterval = 800; // Tiempo en ms (reducido para mayor reactividad)
        
        direccionInput.addEventListener('keyup', function() {
            clearTimeout(typingTimer);
            if (direccionInput.value.trim()) {
                typingTimer = setTimeout(function() {
                    updateFullLocation();
                    // Verificar si tenemos suficiente información para geocodificar
                    const todosLosCamposCompletos = paisInput.value.trim() && 
                                                  provinciaInput.value.trim() && 
                                                  ciudadInput.value.trim() && 
                                                  direccionInput.value.trim();
                    
                    // Siempre actualizar el mapa para mostrar la vista general
                    if (provinciaInput.value.trim() && paisInput.value.trim()) {
                        tryToGeocodeAddress();
                    }
                    
                    // Si tenemos una dirección completa, actualizar la UI para indicar que está lista
                    if (todosLosCamposCompletos) {
                        console.log("Dirección completa lista para geocodificación precisa");
                        // Actualizar indicador visual
                        const indicador = document.getElementById('direccion-estado');
                        const ayudaTexto = document.getElementById('direccion-ayuda');
                        if (indicador) {
                            indicador.className = 'input-group-text bg-success text-white';
                            indicador.innerHTML = '<i class="fas fa-check"></i>';
                        }
                        if (ayudaTexto) {
                            ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                            ayudaTexto.className = 'form-text text-success';
                        }
                    } else {
                        // Restablecer indicador visual
                        const indicador = document.getElementById('direccion-estado');
                        const ayudaTexto = document.getElementById('direccion-ayuda');
                        if (indicador) {
                            indicador.className = 'input-group-text bg-transparent';
                            indicador.innerHTML = '<i class="fas fa-map-marker-alt text-muted"></i>';
                        }
                        if (ayudaTexto) {
                            ayudaTexto.textContent = 'Ingrese la calle y número para ubicación exacta';
                            ayudaTexto.className = 'form-text';
                        }
                    }
                }, doneTypingInterval);
            }
        });
        
        direccionInput.addEventListener('keydown', function() {
            clearTimeout(typingTimer);
        });
        
        direccionInput.addEventListener('change', function() {
            updateFullLocation();
            
            // Verificar si tenemos todos los datos necesarios para una geocodificación completa
            const todosLosCamposCompletos = paisInput.value.trim() && 
                                          provinciaInput.value.trim() && 
                                          ciudadInput.value.trim() && 
                                          direccionInput.value.trim();
            
            if (todosLosCamposCompletos) {
                console.log("Dirección completa, realizando geocodificación precisa");
                // Actualizar indicador visual
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-success text-white';
                    indicador.innerHTML = '<i class="fas fa-check"></i>';
                }
                if (ayudaTexto) {
                    ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                    ayudaTexto.className = 'form-text text-success';
                }
                
                // Forzar un pequeño retraso para que termine de procesar el evento change
                setTimeout(function() {
                    tryToGeocodeAddress();
                }, 100);
            }
        });
        
        direccionInput.addEventListener('blur', function() {
            // Al perder el foco, intentar geocodificar si tenemos datos suficientes
            const todosLosCamposCompletos = paisInput.value.trim() && 
                                           provinciaInput.value.trim() && 
                                           ciudadInput.value.trim() && 
                                           direccionInput.value.trim();
            
            if (todosLosCamposCompletos) {
                console.log("Dirección completa (blur), realizando geocodificación precisa");
                
                // Actualizar indicador visual
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-success text-white';
                    indicador.innerHTML = '<i class="fas fa-check"></i>';
                }
                if (ayudaTexto) {
                    ayudaTexto.textContent = 'Dirección completa - Se colocará un pin en el mapa';
                    ayudaTexto.className = 'form-text text-success';
                }
                
                // Forzar un pequeño retraso para asegurar que los cambios de UI se apliquen
                setTimeout(function() {
                    tryToGeocodeAddress();
                }, 100);
            } else if (direccionInput.value.trim()) {
                // La dirección está parcialmente completa
                const indicador = document.getElementById('direccion-estado');
                const ayudaTexto = document.getElementById('direccion-ayuda');
                if (indicador) {
                    indicador.className = 'input-group-text bg-warning text-white';
                    indicador.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                }
                if (ayudaTexto) {
                    const camposFaltantes = [];
                    if (!paisInput.value.trim()) camposFaltantes.push('país');
                    if (!provinciaInput.value.trim()) camposFaltantes.push('provincia');
                    if (!ciudadInput.value.trim()) camposFaltantes.push('ciudad');
                    
                    ayudaTexto.textContent = 'Falta completar: ' + camposFaltantes.join(', ');
                    ayudaTexto.className = 'form-text text-warning';
                }
            }
        });
        
        direccionInput.addEventListener('input', updateFullLocation);
    }
    
    // Función para intentar geocodificar la dirección progresivamente
    function tryToGeocodeAddress() {
        const pais = paisInput.value.trim();
        const provincia = provinciaInput.value.trim();
        const ciudad = ciudadInput.value.trim();
        const direccion = direccionInput.value.trim();
        
        // Log de datos ingresados
        console.log("Datos para geocodificación:", { pais, provincia, ciudad, direccion });
        
        // Verificar si todos los campos necesarios están completos para colocar el pin
        const todosLosCamposCompletos = pais && provincia && ciudad && direccion;
        
        console.log("¿Todos los campos completos?", todosLosCamposCompletos);
        
        // Solo intentar geocodificar si tenemos al menos la provincia
        if (provincia) {
            console.log("Iniciando geocodificación progresiva con:", { pais, provincia, ciudad, direccion });
            
            // Mostrar el mapa si está oculto
            const mapaDiv = document.getElementById('mapaUbicacion');
            if (mapaDiv.style.display === 'none') {
                toggleMap('mapaUbicacion');
                // Inicializar el mapa después de hacerlo visible
                setTimeout(function() {
                    const map = initMap('mapaUbicacion');
                    if (map) {
                        // Configurar el evento de clic después de inicializar
                        setupMapClickEvent(map, updateLocationData);
                        
                        // Usar geocodificación progresiva para ajustar la vista del mapa
                        geocodeProgressive(
                            { pais, provincia, ciudad, direccion }, 
                            function(lat, lng, result, zoom) {
                                if (lat && lng) {
                                    console.log("Geocodificación exitosa. Coordenadas:", lat, lng);
                                    
                                    // Solo colocar el pin si todos los campos están completos
                                    if (todosLosCamposCompletos) {
                                        console.log("Todos los campos completos, colocando pin...");
                                        
                                        // Forzar un tiempo de espera para asegurar que el mapa está listo
                                        setTimeout(function() {
                                            // Actualizar marcador y centrar mapa con el zoom apropiado
                                            const marker = addOrUpdateMarker(map, lat, lng, zoom);
                                            console.log("Resultado de addOrUpdateMarker:", marker ? "Pin creado" : "Fallo al crear pin");
                                            
                                            // Verificar si se creó el marcador
                                            if (!marker) {
                                                console.error("No se pudo crear el marcador. Intentando nuevamente...");
                                                // Intentar nuevamente con coordenadas verificadas
                                                marker = addOrUpdateMarker(map, parseFloat(lat), parseFloat(lng), zoom);
                                                
                                                // Si aún falla, usar método de emergencia
                                                if (!marker && window.debugEcosmart) {
                                                    console.warn("Intentando método de emergencia para crear marcador");
                                                    window.debugEcosmart.emergencyCreateMarker(lat, lng);
                                                }
                                            }
                                            
                                            // Verificar después de un momento que el marcador sigue visible
                                            setTimeout(function() {
                                                if (window.debugEcosmart) {
                                                    window.debugEcosmart.verifyMarker();
                                                    window.debugEcosmart.logState();
                                                }
                                            }, 500);
                                            
                                            // Actualizar datos de la ubicación
                                            updateLocationData(lat.toFixed(6), lng.toFixed(6));
                                        }, 200);
                                    } else {
                                        console.log("No todos los campos están completos, solo centrando mapa sin pin");
                                        // Solo centrar el mapa sin colocar el pin
                                        map.setView([lat, lng], zoom);
                                    }
                                } else {
                                    console.warn("Geocodificación falló. No se obtuvieron coordenadas.");
                                }
                            }
                        );
                    }
                }, 300);
            } else {
                // El mapa ya está visible, verificar si está inicializado
                if (ecosmartMap) {
                    // Usar geocodificación progresiva
                    geocodeProgressive(
                        { pais, provincia, ciudad, direccion }, 
                        function(lat, lng, result, zoom) {
                            if (lat && lng) {
                                // Solo colocar el pin si todos los campos están completos
                                if (todosLosCamposCompletos) {
                                    // Actualizar marcador y centrar mapa con el zoom apropiado
                                    addOrUpdateMarker(ecosmartMap, lat, lng, zoom);
                                    
                                    // Actualizar datos de la ubicación
                                    updateLocationData(lat.toFixed(6), lng.toFixed(6));
                                } else {
                                    // Solo centrar el mapa sin colocar el pin
                                    ecosmartMap.setView([lat, lng], zoom);
                                }
                            }
                        }
                    );
                }
            }
        }
    }
    
    // Adaptación de la interfaz según el tipo de instalación seleccionado
    const tipoInstalacionSelect = document.getElementById('tipo_instalacion');
    if (tipoInstalacionSelect) {
        tipoInstalacionSelect.addEventListener('change', function() {
            const tipoSeleccionado = this.value;
            const unidadCapacidad = document.getElementById('unidad_capacidad');
            const capacidadDescripcion = document.getElementById('capacidad_descripcion');
            const campoInclinacion = document.getElementById('campo_inclinacion');
            const campoOrientacion = document.getElementById('campo_orientacion');
            const campoAlturaTorre = document.getElementById('campo_altura_torre');
            
            // Ocultar todos los campos específicos por defecto
            campoInclinacion.style.display = 'none';
            campoOrientacion.style.display = 'none';
            campoAlturaTorre.style.display = 'none';
            
            // Mostrar campos según el tipo seleccionado
            if (tipoSeleccionado === 'solar') {
                unidadCapacidad.textContent = 'kW';
                capacidadDescripcion.textContent = 'Potencia total del sistema fotovoltaico';
                campoInclinacion.style.display = 'block';
                campoOrientacion.style.display = 'block';
            } else if (tipoSeleccionado === 'eolica') {
                unidadCapacidad.textContent = 'kW';
                capacidadDescripcion.textContent = 'Potencia nominal del aerogenerador';
                campoAlturaTorre.style.display = 'block';
            } else if (tipoSeleccionado === 'termotanque') {
                unidadCapacidad.textContent = 'litros';
                capacidadDescripcion.textContent = 'Capacidad del termotanque solar';
                campoInclinacion.style.display = 'block';
                campoOrientacion.style.display = 'block';
            }
        });
    }
    
    // Validación del formulario
    const formulario = document.getElementById('simuladorForm');
    if (formulario) {
        formulario.addEventListener('submit', function(event) {
            // Asegurarse de que la ubicación completa se actualice
            updateFullLocation();
            
            // Validar que tengamos al menos provincia y ciudad o coordenadas
            const provincia = provinciaInput.value;
            const ciudad = ciudadInput.value;
            const latitud = latitudInput.value;
            const longitud = longitudInput.value;
            
            if ((!provincia || !ciudad) && (!latitud || !longitud)) {
                event.preventDefault();
                alert('Por favor, indique su ubicación seleccionando provincia y ciudad o usando el mapa para seleccionar coordenadas.');
                return false;
            }
            
            // Validar capacidad
            const capacidad = document.getElementById('capacidad').value;
            const capacidadNum = parseFloat(capacidad);
            if (isNaN(capacidadNum) || capacidadNum <= 0) {
                event.preventDefault();
                alert('Por favor, ingrese un valor válido para la capacidad.');
                return false;
            }
            
            // Validar consumo mensual
            const consumo = document.getElementById('consumo_mensual').value;
            const consumoNum = parseFloat(consumo);
            if (isNaN(consumoNum) || consumoNum <= 0) {
                event.preventDefault();
                alert('Por favor, ingrese un valor válido para el consumo mensual.');
                return false;
            }
            
            return true;
        });
    }
});
</script>
{% endblock %}