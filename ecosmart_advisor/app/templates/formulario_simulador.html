{% extends "layout.html" %}

{% block title %}Simulador{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="h4 mb-0"><i class="fas fa-chart-line me-2"></i>Simulador de Energía Renovable</h2>
            </div>
            <div class="card-body p-4">
                <p class="lead mb-4">En esta sección puede simular distintos escenarios de instalación de sistemas de energía renovable para evaluar rendimiento, ahorro y beneficio ambiental.</p>
                
                <form id="simuladorForm" method="POST" action="{{ url_for('simulador.simulador') }}">
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Configuración de Simulación</h3>
                        
                        <div class="mb-3">
                            <label for="tipo_instalacion" class="form-label">Tipo de Instalación <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipo_instalacion" name="tipo_instalacion" required>
                                <option value="" selected disabled>Seleccione una opción</option>
                                <option value="solar">Sistema Solar Fotovoltaico</option>
                                <option value="eolica">Sistema Eólico (aerogenerador)</option>
                                <option value="termotanque">Termotanque Solar</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="capacidad" class="form-label">Capacidad <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text" id="unidad_prefijo"><i class="fas fa-bolt"></i></span>
                                <input type="number" class="form-control" id="capacidad" name="capacidad" 
                                       placeholder="Capacidad del sistema" min="0.1" step="0.1" required>
                                <span class="input-group-text" id="unidad_capacidad">kW</span>
                            </div>
                            <div class="form-text" id="capacidad_descripcion">Potencia total del sistema fotovoltaico</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ubicación <span class="text-danger">*</span></label>
                            
                            <div class="row g-3 mb-2">
                                <div class="col-md-4">
                                    <label for="provincia" class="form-label small">Provincia/Estado</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map"></i></span>
                                        <input type="text" class="form-control" id="provincia" name="provincia" 
                                               placeholder="Provincia/Estado">
                                    </div>
                                    <div id="sugerenciasProvincia" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-4">
                                    <label for="ciudad" class="form-label small">Ciudad/Localidad</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-city"></i></span>
                                        <input type="text" class="form-control" id="ciudad" name="ciudad" 
                                               placeholder="Ciudad/Localidad">
                                    </div>
                                    <div id="sugerenciasCiudad" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                                </div>
                                <div class="col-md-4">
                                    <label for="direccion" class="form-label small">Dirección (opcional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-home"></i></span>
                                        <input type="text" class="form-control" id="direccion" name="direccion" 
                                               placeholder="Calle, número...">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campos ocultos para almacenar la ubicación y coordenadas -->
                            <input type="hidden" id="ubicacion" name="ubicacion" required>
                            <input type="hidden" id="latitud" name="latitud">
                            <input type="hidden" id="longitud" name="longitud">
                            
                            <div class="mt-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">O seleccione su ubicación en el mapa</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="mostrarMapa">
                                        <i class="fas fa-map-marked-alt me-1"></i>Mostrar/Ocultar Mapa
                                    </button>
                                </div>
                                <div id="mapaUbicacion" class="rounded border mb-2" style="height: 300px; display: none;">
                                    <!-- El mapa se cargará aquí con JavaScript -->
                                </div>
                                <div class="form-text" id="coordenadasSeleccionadas">
                                    Coordenadas: <span id="latitudDisplay">--</span>, <span id="longitudDisplay">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="consumo_mensual" class="form-label">Consumo Eléctrico Mensual <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-plug"></i></span>
                                <input type="number" class="form-control" id="consumo_mensual" name="consumo_mensual" 
                                       placeholder="Consumo mensual en kWh" min="1" required>
                                <span class="input-group-text">kWh/mes</span>
                            </div>
                            <div class="form-text">Consumo promedio mensual de electricidad</div>
                        </div>
                        
                        <div class="mb-3" id="factores_opcionales">
                            <div class="card border-light mb-3">
                                <div class="card-header bg-light">Factores opcionales (valores por defecto recomendados)</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6" id="campo_eficiencia">
                                            <label for="eficiencia" class="form-label">Eficiencia del sistema</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="eficiencia" name="eficiencia" 
                                                       placeholder="Eficiencia" min="1" max="100" value="85" step="0.1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="campo_inclinacion">
                                            <label for="inclinacion" class="form-label">Inclinación paneles</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="inclinacion" name="inclinacion" 
                                                       placeholder="Inclinación" min="0" max="90" value="30">
                                                <span class="input-group-text">grados</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6" id="campo_orientacion">
                                            <label for="orientacion" class="form-label">Orientación</label>
                                            <select class="form-select" id="orientacion" name="orientacion">
                                                <option value="norte" selected>Norte</option>
                                                <option value="noreste">Noreste</option>
                                                <option value="este">Este</option>
                                                <option value="sureste">Sureste</option>
                                                <option value="sur">Sur</option>
                                                <option value="suroeste">Suroeste</option>
                                                <option value="oeste">Oeste</option>
                                                <option value="noroeste">Noroeste</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6" id="campo_altura_torre">
                                            <label for="altura_torre" class="form-label">Altura de la torre</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="altura_torre" name="altura_torre" 
                                                       placeholder="Altura" min="1" value="15">
                                                <span class="input-group-text">metros</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play-circle me-2"></i>Ejecutar Simulación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Primero cargar la hoja de estilos de Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>

<!-- Luego cargar el JavaScript de Leaflet (versión simplificada) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Verificar que Leaflet se haya cargado correctamente -->
<script>
// Verificar que la biblioteca Leaflet esté cargada
window.addEventListener('load', function() {
    if (typeof L === 'undefined') {
        console.error("Error: La biblioteca Leaflet no pudo cargarse.");
        alert("Error al cargar los mapas. Por favor recargue la página o intente con otro navegador.");
    } else {
        console.log("Leaflet cargado correctamente");
    }
});</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Inicializando la página del simulador...");
        
        // Variables globales para el mapa
        let mapa = null;
        let marcador = null;
        const mapContainer = document.getElementById('mapaUbicacion');
        const btnMostrarMapa = document.getElementById('mostrarMapa');
        
        // Referencias a elementos del formulario
        const provinciaInput = document.getElementById('provincia');
        const ciudadInput = document.getElementById('ciudad');
        const direccionInput = document.getElementById('direccion');
        const ubicacionInput = document.getElementById('ubicacion');
        const latitudInput = document.getElementById('latitud');
        const longitudInput = document.getElementById('longitud');
        const latitudDisplay = document.getElementById('latitudDisplay');
        const longitudDisplay = document.getElementById('longitudDisplay');
        
        // Función para inicializar el mapa
        function inicializarMapa() {
            console.log("Inicializando mapa...");
            
            // Si el mapa ya está inicializado, sólo actualizar tamaño
            if (mapa) {
                console.log("El mapa ya existe, actualizando tamaño");
                mapa.invalidateSize();
                return;
            }
            
            try {
                // Verificar que Leaflet esté correctamente cargado
                if (typeof L === 'undefined') {
                    console.error("Error: La biblioteca Leaflet no está cargada.");
                    alert("Error al cargar el mapa. Por favor, actualice la página y vuelva a intentarlo.");
                    return;
                }
                
                console.log("Leaflet disponible:", typeof L);
                
                // Crear el mapa centrado en Argentina por defecto
                console.log("Creando nuevo mapa");
                mapa = L.map('mapaUbicacion').setView([-34.6037, -58.3816], 5);
                
                // Añadir la capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapa);
                
                // Refrescar el mapa después de mostrarlo (arregla problemas de renderizado)
                setTimeout(() => {
                    console.log("Actualizando tamaño del mapa");
                    mapa.invalidateSize();
                }, 500);
                
                // Evento para seleccionar ubicación en el mapa
                mapa.on('click', function(e) {
                    console.log("Click en el mapa", e.latlng);
                    const lat = e.latlng.lat.toFixed(6);
                    const lng = e.latlng.lng.toFixed(6);
                    
                    // Actualizar campos ocultos
                    latitudInput.value = lat;
                    longitudInput.value = lng;
                    
                    // Actualizar textos de coordenadas
                    latitudDisplay.textContent = lat;
                    longitudDisplay.textContent = lng;
                    
                    // Añadir o mover el marcador
                    if (marcador) {
                        marcador.setLatLng(e.latlng);
                    } else {
                        marcador = L.marker(e.latlng).addTo(mapa);
                    }
                    
                    // Actualizar el campo de ubicación completa
                    actualizarUbicacionCompleta();
                    
                    // Buscar información de la ubicación (geolocalización inversa)
                    buscarInformacionUbicacion(lat, lng);
                });
                
                console.log("Mapa inicializado correctamente");
            } catch (error) {
                console.error("Error al inicializar el mapa:", error);
            }
        }
        
        // Evento para mostrar/ocultar el mapa
        if (btnMostrarMapa) {
            console.log("Configurando botón mostrar/ocultar mapa");
            btnMostrarMapa.addEventListener('click', function(e) {
                e.preventDefault(); // Prevenir comportamiento por defecto
                
                console.log("Click en botón mostrar/ocultar mapa");
                console.log("Estado actual del display:", mapContainer.style.display);
                
                // Forzar un estilo computado para obtener el valor real
                const computedStyle = window.getComputedStyle(mapContainer);
                const isHidden = computedStyle.display === 'none';
                
                console.log("¿Está oculto según estilo computado?", isHidden);
                
                if (isHidden) {
                    console.log("Mostrando mapa");
                    mapContainer.style.display = 'block';
                    // Inicializar el mapa después de hacerlo visible
                    setTimeout(inicializarMapa, 100);
                } else {
                    console.log("Ocultando mapa");
                    mapContainer.style.display = 'none';
                }
            });
        }
        
        // Función para buscar información de ubicación por coordenadas
        function buscarInformacionUbicacion(lat, lng) {
            console.log("Buscando información para", lat, lng);
            // Usar un servicio de geocodificación inversa
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    console.log("Datos de geolocalización inversa:", data);
                    if (data && data.address) {
                        // Extraer información de la dirección
                        const direccion = data.address.road || data.address.pedestrian || '';
                        const numero = data.address.house_number || '';
                        const ciudad = data.address.city || data.address.town || data.address.village || '';
                        const provincia = data.address.state || '';
                        
                        // Actualizar campos si están disponibles
                        if (provincia) provinciaInput.value = provincia;
                        if (ciudad) ciudadInput.value = ciudad;
                        if (direccion) {
                            let direccionCompleta = direccion;
                            if (numero) direccionCompleta += ' ' + numero;
                            direccionInput.value = direccionCompleta;
                        }
                        
                        // Actualizar ubicación completa
                        actualizarUbicacionCompleta();
                    }
                })
                .catch(error => {
                    console.error('Error al obtener información de ubicación:', error);
                });
        }
        
        // Función para actualizar el campo oculto de ubicación completa
        function actualizarUbicacionCompleta() {
            const provincia = provinciaInput ? provinciaInput.value.trim() : '';
            const ciudad = ciudadInput ? ciudadInput.value.trim() : '';
            const direccion = direccionInput ? direccionInput.value.trim() : '';
            const latitud = latitudInput ? latitudInput.value.trim() : '';
            const longitud = longitudInput ? longitudInput.value.trim() : '';
            
            console.log("Actualizando ubicación completa con:", {provincia, ciudad, direccion, latitud, longitud});
            
            let ubicacionCompleta = '';
            
            // Primero añadir dirección textual si existe
            if (direccion) {
                ubicacionCompleta += direccion;
                if (ciudad || provincia) ubicacionCompleta += ', ';
            }
            
            if (ciudad) {
                ubicacionCompleta += ciudad;
                if (provincia) ubicacionCompleta += ', ';
            }
            
            if (provincia) {
                ubicacionCompleta += provincia;
            }
            
            // Si hay coordenadas y no hay texto, usar las coordenadas
            if ((!ubicacionCompleta || ubicacionCompleta.trim() === ',') && latitud && longitud) {
                ubicacionCompleta = `${latitud}, ${longitud}`;
            }
            
            // Asignar al campo oculto
            if (ubicacionCompleta && ubicacionInput) {
                console.log("Ubicación completa:", ubicacionCompleta);
                ubicacionInput.value = ubicacionCompleta;
            }
        }
        
        // Actualizar ubicación cuando cambian los campos individuales
        ['provincia', 'ciudad', 'direccion'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', actualizarUbicacionCompleta);
                element.addEventListener('input', actualizarUbicacionCompleta);
            }
        });
        
        // Adaptación de la interfaz según el tipo de instalación seleccionado
        const tipoInstalacionSelect = document.getElementById('tipo_instalacion');
        if (tipoInstalacionSelect) {
            tipoInstalacionSelect.addEventListener('change', function() {
                const tipoSeleccionado = this.value;
                const unidadCapacidad = document.getElementById('unidad_capacidad');
                const capacidadDescripcion = document.getElementById('capacidad_descripcion');
                const campoInclinacion = document.getElementById('campo_inclinacion');
                const campoOrientacion = document.getElementById('campo_orientacion');
                const campoAlturaTorre = document.getElementById('campo_altura_torre');
                
                // Ocultar todos los campos específicos
                campoInclinacion.style.display = 'none';
                campoOrientacion.style.display = 'none';
                campoAlturaTorre.style.display = 'none';
                
                // Mostrar campos según el tipo seleccionado
                if (tipoSeleccionado === 'solar') {
                    unidadCapacidad.textContent = 'kW';
                    capacidadDescripcion.textContent = 'Potencia total del sistema fotovoltaico';
                    campoInclinacion.style.display = 'block';
                    campoOrientacion.style.display = 'block';
                } else if (tipoSeleccionado === 'eolica') {
                    unidadCapacidad.textContent = 'kW';
                    capacidadDescripcion.textContent = 'Potencia nominal del aerogenerador';
                    campoAlturaTorre.style.display = 'block';
                } else if (tipoSeleccionado === 'termotanque') {
                    unidadCapacidad.textContent = 'litros';
                    capacidadDescripcion.textContent = 'Capacidad del termotanque solar';
                    campoInclinacion.style.display = 'block';
                    campoOrientacion.style.display = 'block';
                }
            });
        }
        
        // Validaciones del formulario
        const form = document.getElementById('simuladorForm');
        if (form) {
            form.addEventListener('submit', function(event) {
                // Asegurar que la ubicación completa se actualice antes de enviar
                actualizarUbicacionCompleta();
                
                let ubicacion = ubicacionInput.value;
                let tipoInstalacion = tipoInstalacionSelect.value;
                let capacidad = document.getElementById('capacidad').value;
                let consumoMensual = document.getElementById('consumo_mensual').value;
                
                console.log("Validando formulario:", {ubicacion, tipoInstalacion, capacidad, consumoMensual});
                
                // Verificar que tengamos al menos provincia y ciudad o coordenadas
                const provincia = provinciaInput.value;
                const ciudad = ciudadInput.value;
                const latitud = latitudInput.value;
                const longitud = longitudInput.value;
                
                if ((!provincia || !ciudad) && (!latitud || !longitud)) {
                    event.preventDefault();
                    alert('Por favor, indique su ubicación seleccionando provincia y ciudad o usando el mapa para seleccionar coordenadas.');
                    return false;
                }
                
                // Validar capacidad
                const capacidadNum = parseFloat(capacidad);
                if (isNaN(capacidadNum) || capacidadNum <= 0) {
                    event.preventDefault();
                    alert('Por favor, ingrese un valor válido para la capacidad.');
                    return false;
                }
                
                // Validar consumo mensual
                const consumoNum = parseFloat(consumoMensual);
                if (isNaN(consumoNum) || consumoNum <= 0) {
                    event.preventDefault();
                    alert('Por favor, ingrese un valor válido para el consumo mensual.');
                    return false;
                }
                
                console.log("Formulario validado correctamente");
                return true;
            });
        }
    });
</script>
{% endblock %}